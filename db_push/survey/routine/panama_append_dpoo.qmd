---
title: "panama_append"
format: html
editor: source
---
# Setup

## Load Packages

```{r}
librarian::shelf(tidyverse, dbplyr, here, janitor, lubridate, RPostgres, stringr, DBI, parsedate, uuid, hms, RIBBiTR-BII/ribbitrrr)
# librarian::shelf(RIBBiTR-BII/ribbitrrr, update_all = TRUE)

## Connect to DB
dbcon <- hopToDB("ribbitr")

## Pull metadata from database
mdc = tbl(dbcon, Id("public", "all_columns")) %>%
  filter(table_schema == "survey_data") %>%
  collect()

## Point to local data directory
ddir = Sys.getenv("data_dir")  # data directory
# Keeping .csv files in a central directory. Naming convention uses download date to distinguish batches.
wddir = here(ddir, "fulcrum", 'panama', '2024-11-18', "panama_field_3_0") # working data directory

```


# 0 - Data Plan

## Goals

- Integrate batches of Penn survey data with other RIBBiTR data (including other Penn data) for combined analysis
- Compare with existing data to avoid duplicating, and facilitate automated updating
- Quality control for red flag data (potential or known issues)
- Upload to Database in transaction
- log transaction

## Data chains (someday we can automate this...)

- capture / survey / visit / site / region / location
- aural / survey / visit / site / region / location
- ves / survey / visit / site / region / location

# 1 - Import data


## Pull dependent tables for each data chain

### use naming convention "db\_" to distinguish the source

```{r}
# pull relevant chain tables from DB
db_aural = tbl(dbcon, Id("survey_data", "aural"))
db_capture = tbl(dbcon, Id("survey_data", "capture"))
db_ves = tbl(dbcon, Id("survey_data", "ves"))
db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_visit = tbl(dbcon, Id("survey_data", "visit"))
db_site = tbl(dbcon, Id("survey_data", "site"))
db_region = tbl(dbcon, Id("survey_data", "region"))
db_country = tbl(dbcon, Id("survey_data", "country"))

```


## Load most recent raw CSV Exports
- use naming convention "raw_" to distinguish source
- name related tables similarly for natural grouping

```{r}
# list.files(path = here(wddir))

# general visit table
raw_visit_info <- read_csv(here(wddir, "panama_field_3_0.csv"))

# general survey table
raw_survey_info <- read_csv(here(wddir, "panama_field_3_0_survey_table_data.csv"))

# survey observations
raw_aural <- read_csv(here(wddir, "panama_field_3_0_individual_call.csv"))
raw_capture <- read_csv(here(wddir, "panama_field_3_0_individual_capture.csv"))
raw_capture_target <- read_csv(here(wddir, "panama_field_3_0_individual_capture_target.csv"))
raw_ves <- read_csv(here(wddir, "panama_field_3_0_individual_visual.csv"))
raw_cmr <- read_csv(here(wddir, "panama_field_3_0_individual_cmr.csv"))

# edna
raw_edna <- read_csv(here(wddir, "panama_field_3_0_edna_samples.csv"))


# # non RIBBiTR
# raw_tadpole <- read_csv(here(wddir, "panama_field_3_0_tadpoles_sampling.csv"))
# raw_acoustic <- read_csv(here(wddir, "panama_field_3_0_bioacousticdata.csv"))
# raw_hobo <- read_csv(here(wddir, "panama_field_3_0_hobos_data.csv"))

raw_tables = c(
  "raw_visit_info",
  "raw_survey_info",
  "raw_aural",
  "raw_capture",
  "raw_capture_target",
  "raw_ves",
  "raw_cmr",
  "raw_edna"
)


```
# 2 - Clean data

## check for null columns & duplicated rows
- purely informational, all action taken in next step

```{r}

null_columns = function(dataframe) {
  filtered = dataframe %>%
    select(where(~ all(is.na(.)))) %>%
    colnames()
}

for (table in raw_tables) {
  cat(table, "\n\t", "Null columns:\n\t\t")
  cat(paste(null_columns(get(table)), collapse = "\n\t\t"))
  cat("\n\tAny duplicate columns:\n\t\t")
  cat(any(duplicated(get(table))), "\n")
  cat("\n\tOne-to_one columns:\n\t\t")
  cat(paste(get_one_to_one(get(table)), collapse="\n\t\t"))
  cat("\n")
}


```

## Drop irrelevant & fix structural issues
- clean column names
- rename/mutate/drop specific columns
- Split, concatenate, coalesce related columns
- Convert to accurate data types/units/naming conventions
- drop unnecessary rows
- NA formatting

```{r}

# Fulcrum columns to drop. Best practice to drop by name
to_drop = c(
  "created_at",
  "updated_at",
  "created_by",
  "updated_by",
  "system_created_at",
  "system_updated_at",
  "version",
  "status",
  "project",
  "assigned_to",
  "latitude", # could this be useful?
  "longitude", # could this be useful?
  "geometry",
  "fulcrum_record_id",
  "site_other" # ignoring sites outside RIBBiTR... could include though.
)

calc_duration = function(start_time, end_time) {
  duration = if_else(end_time < start_time,
                         as_hms(86400) - start_time + end_time,
                         end_time - start_time)
  duration = duration / 60
  duration = str_remove(duration, " secs")
  duration = as.integer(round(as.numeric(duration), 0))
}

# Begin cleaning
clean_visit_info = raw_visit_info %>%
  clean_names() %>%
  select(-any_of(to_drop)) %>%
  filter(!if_all(everything(), is.na))

clean_survey_info = raw_survey_info %>%
  clean_names() %>%
  select(-any_of(to_drop)) %>%
  filter(!if_all(everything(), is.na))

clean_aural = raw_aural %>%
  clean_names() %>%
  select(-any_of(to_drop)) %>%
  filter(!if_all(everything(), is.na))

clean_capture = raw_capture %>%
  clean_names() %>%
  select(-any_of(to_drop)) %>%
  filter(!if_all(everything(), is.na))

clean_capture_target = raw_capture_target %>%
  clean_names() %>%
  select(-any_of(to_drop)) %>%
  filter(!if_all(everything(), is.na))

clean_ves = raw_ves%>%
  clean_names() %>%
  select(-any_of(to_drop)) %>%
  filter(!if_all(everything(), is.na))

clean_cmr = raw_cmr %>%
  clean_names() %>%
  select(-any_of(to_drop)) %>%
  filter(!if_all(everything(), is.na))

clean_edna = raw_edna %>%
  clean_names() %>%
  select(-any_of(to_drop)) %>%
  filter(!if_all(everything(), is.na))

```

# 3 Checks

## unify visit

```{r}
unique_visit <- bind_rows(clean_survey_info,
                          clean_aural_survey,
                          clean_capture_survey,
                          clean_edna_survey,
                          clean_ves_survey) %>% 
  select(date, site, time_of_day) %>%
  distinct()

unified_visit = clean_survey_info %>%
  full_join(unique_visit, by = c("site", "date", "time_of_day")) %>%
  filter(!is.na(site))

```

## gel visit
```{r}
gelled_visit = unified_visit %>%
  inner_join(db_site %>%
              select(tbl_keys("site", mdc)) %>%
              collect(),
            by = tbl_nkey("site", mdc)) %>%
  left_join(db_visit %>%
              select(tbl_keys("visit", mdc)) %>%
              collect(),
            by = tbl_nkey("visit", mdc)) %>%
  group_by_at(tbl_nkey("visit", mdc)) %>%
  mutate(visit_id = ifelse(is.na(visit_id), UUIDgenerate(), visit_id)) %>%
  ungroup()

```

## Generate stats for log
```{r}
dblog = list()
dblog$date_min = min(gelled_visit$date)
dblog$date_max = max(gelled_visit$date)
dblog$site = gelled_visit$site %>% unique()
dblog$site_id = gelled_visit$site_id %>% unique()
dblog$region = db_site %>%
  left_join(db_region, by = "region_id") %>%
  filter(site %in% dblog$sites) %>%
  pull(region) %>%
  unique()

```

## subset visit
```{r}
subset_visit = gelled_visit %>%
  select(any_of(colnames(db_visit))) %>%
  distinct() %>%
  drop_na(visit_id)

compare_visit = compare_df_cols(db_visit %>%
                                  filter(FALSE) %>%
                                  collect(), subset_visit)



tray = compare_for_staging(db_visit %>%
                             filter(date >= dblog$date_min,
                                    site_id %in% dblog$site_id) %>%
                             collect(),
                           subset_visit, tbl_pkey('visit', mdc), return_all = TRUE, report = "visit")
final_visit = bind_rows(tray$insert,
                        tray$update)

# upsert visit?
x_visit = (nrow(final_visit) > 0)

```

## upsert visits

```{r}
if (x_visit) {
  temp_visit = stage_to_temp(dbcon, db_visit, final_visit)
  pointer = tbl(dbcon, temp_visit)
  db_visit = rows_upsert(db_visit, pointer, by="visit_id", in_place=TRUE)
}

```

## reload visits
```{r}
db_visit = tbl(dbcon, Id("survey_data", "visit"))
```

# One chain at a time

## Aural chain
- aural / survey / visit / site / region / location

### 3 - Unify aural data

```{r}
unified_aural = clean_aural_obs %>%
  full_join(clean_aural_survey, by = c("fulcrum_parent_id" = "fulcrum_id")) %>%
  select(-fulcrum_parent_id) %>%
  left_join(clean_survey_info, by = c("site", "date", "time_of_day")) %>%
  inner_join(db_site %>%
              select(tbl_keys("site", mdc)) %>%
              collect(),
            by = tbl_nkey("site", mdc)) %>%
  left_join(db_visit %>%
              select(tbl_keys("visit", mdc)) %>%
              collect(),
            by = tbl_nkey("visit", mdc)) %>%
  left_join(db_survey %>%
              select(tbl_keys("survey", mdc)) %>%
              filter(!is.na(visit_id)) %>%
              collect(),
            by = tbl_nkey("survey", mdc)) %>%
  filter(!is.na(site),
         !is.na(date))

```

### 4 - Gelled aural data

```{r}
gelled_aural = unified_aural %>%
  group_by_at(tbl_nkey("survey", mdc)) %>%
  mutate(start_time = as_hms(mean(start_time)),
         end_time = as_hms(mean(end_time)),
         duration_minutes = calc_duration(start_time, end_time),
         comments_survey = str_c(comments_survey, collapse = ", "),
         survey_id = ifelse(is.na(survey_id), first(fulcrum_id), survey_id),
         survey_id = ifelse(is.na(survey_id), UUIDgenerate(), survey_id)) %>%
  ungroup() %>%
  select(-fulcrum_id)

```

### 5 - Subset aural tables

```{r}

# survey
subset_aural_survey = gelled_aural %>%
  select(any_of(colnames(db_survey))) %>%
  distinct() %>%
  drop_na(survey_id)

# compare columns
compare_aural_survey = compare_df_cols(db_survey %>%
                                  filter(FALSE) %>%
                                  collect(), subset_aural_survey)

tray = compare_for_staging(db_survey %>% collect(), subset_aural_survey, tbl_pkey('survey', mdc), return_all = TRUE, report = "aural_survey")
final_aural_survey = bind_rows(tray$insert,
                               tray$update)

# aural
subset_aural = gelled_aural %>%
  select(any_of(colnames(db_aural))) %>%
  distinct() %>%
  drop_na(aural_id)

# compare columns
compare_aural = compare_df_cols(db_aural %>%
                                  filter(FALSE) %>%
                                  collect(), subset_aural)

tray = compare_for_staging(db_aural %>% collect(), subset_aural, tbl_pkey('aural', mdc), return_all = TRUE, report = "aural")
final_aural = bind_rows(tray$insert,
                        tray$update)

# anything to upsert?
x_aural = (nrow(final_aural_survey) > 0) | (nrow(final_aural) > 0)

```

### Stage and commit aural tables

```{r}

if (x_aural) {
  # begin transaction temp
  dbBegin(dbcon)
  
  tryCatch(
    {
      temp_aural_survey = stage_to_temp(dbcon, db_survey, final_aural_survey)
      temp_aural = stage_to_temp(dbcon, db_aural, final_aural)
      
      
      pointer = tbl(dbcon, temp_aural_survey)
      rows_upsert(db_survey, pointer, by=tbl_nkey("survey", mdc), in_place=TRUE)
      
      pointer = tbl(dbcon, temp_aural)
      rows_upsert(db_aural, pointer, by=tbl_pkey("aural", mdc), in_place=TRUE)
      
      # Commit the transaction if successful
      dbCommit(dbcon)
      print("Transaction successful!")
      
    }, error = function(e) {
      # Rollback in case of error
      dbRollback(dbcon)
      message("Transaction failed: ", e$message)
    })
}
```


## VES chain
- ves / survey / visit / site / region / location

### Reload tables
```{r}
db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_aural = tbl(dbcon, Id("survey_data", "aural"))
```



### Unify ves data
```{r}
unified_ves = clean_ves_obs %>%
  full_join(clean_ves_survey, by = c("fulcrum_parent_id" = "fulcrum_id")) %>%
  select(-fulcrum_parent_id) %>%
  left_join(clean_survey_info, by = c("site", "date", "time_of_day")) %>%
  inner_join(db_site %>%
              select(tbl_keys("site", mdc)) %>%
              collect(),
            by = tbl_nkey("site", mdc)) %>%
  left_join(db_visit %>%
              select(tbl_keys("visit", mdc)) %>%
              collect(),
            by = tbl_nkey("visit", mdc)) %>%
  left_join(db_survey %>%
              select(tbl_keys("survey", mdc)) %>%
              filter(!is.na(visit_id)) %>%
              collect(),
            by = tbl_nkey("survey", mdc)) %>%
  filter(!is.na(site),
         !is.na(date))

```

### Gel ves data
```{r}
gelled_ves = unified_ves %>%
  group_by_at(tbl_nkey("survey", mdc)) %>%
  mutate(start_time = as_hms(mean(start_time)),
         end_time = as_hms(mean(end_time)),
         duration_minutes = calc_duration(start_time, end_time),
         comments_survey = str_c(comments_survey, collapse = ", "),
         survey_id = ifelse(is.na(survey_id), first(fulcrum_id), survey_id),
         survey_id = ifelse(is.na(survey_id), UUIDgenerate(), survey_id)) %>%
  ungroup() %>%
  select(-fulcrum_id)
```

### 5 - Subset final ves tables

```{r}

# survey
subset_ves_survey = gelled_ves %>%
  select(any_of(colnames(db_survey))) %>%
  distinct() %>%
  drop_na(survey_id)

# compare columns
compare_ves_survey = compare_df_cols(db_survey %>%
                                  filter(FALSE) %>%
                                  collect(), subset_ves_survey)

tray = compare_for_staging(db_survey %>% collect(), subset_ves_survey, tbl_pkey('survey', mdc), return_all = TRUE, report = "ves_survey")
final_ves_survey = bind_rows(tray$insert,
                             tray$update)


# aural
subset_ves = gelled_ves %>%
  select(any_of(colnames(db_ves))) %>%
  distinct() %>%
  drop_na(ves_id)

# compare columns
compare_ves = compare_df_cols(db_ves %>%
                                  filter(FALSE) %>%
                                  collect(), subset_ves)

tray = compare_for_staging(db_ves %>% collect(), subset_ves, tbl_pkey('ves', mdc), return_all = TRUE, report = "ves")
final_ves = bind_rows(tray$insert,
                      tray$update)

x_ves = (nrow(final_ves_survey) > 0) | (nrow(final_ves) > 0)

```

### Stage and commit aural tables

```{r}
if (x_ves) {
  # begin transaction temp
  dbBegin(dbcon)
  
  tryCatch(
    {
      temp_ves_survey = stage_to_temp(dbcon, db_survey, final_ves_survey)
      temp_ves = stage_to_temp(dbcon, db_ves, final_ves)
      
      
      pointer = tbl(dbcon, temp_ves_survey)
      rows_upsert(db_survey, pointer, by=tbl_nkey("survey", mdc), in_place=TRUE)
      
      pointer = tbl(dbcon, temp_ves)
      rows_upsert(db_ves, pointer, by=tbl_pkey("ves", mdc), in_place=TRUE)
      
      # Commit the transaction if successful
      dbCommit(dbcon)
      print("Transaction successful!")
      
    }, error = function(e) {
      # Rollback in case of error
      dbRollback(dbcon)
      message("Transaction failed: ", e$message)
    })
}

```

## Reload tables
```{r}
db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_ves = tbl(dbcon, Id("survey_data", "ves"))
```

## Capture chain
- capture / survey / visit / site / region / location

```{r}

unified_sample =  clean_sample_obs %>% 
  full_join(clean_sample_processing, by= c("fulcrum_parent_id" = "fulcrum_id")) %>%
  unite("comments_sample", c("comments_sample.x", "comments_sample.y"), sep=",", remove = TRUE, na.rm = TRUE) %>%
  select(-fulcrum_id,
         -fulcrum_parent_id)

unified_capture = clean_capture_obs %>%
  full_join(clean_capture_survey, by = c("fulcrum_parent_id" = "fulcrum_id")) %>%
  select(-fulcrum_parent_id) %>%
  mutate(temp_capture_id = fulcrum_id) %>%
  full_join(unified_sample, by=c("site", "date", "bag_id")) %>%
  mutate(species_capture = coalesce(species_capture.y, species_capture.x)) %>%
  select(-time_of_day.x,
         -time_of_day.y,
         -species_capture.x,
         -species_capture.y) %>%
  unite("comments_capture", c("comments_capture", "comments_sample"), sep=",", remove = TRUE, na.rm = TRUE) %>%
  left_join(clean_survey_info, by = c("site", "date")) %>%
  select(-fulcrum_id) %>%
  inner_join(db_site %>%
              select(tbl_keys("site", mdc)) %>%
              collect(),
            by = tbl_nkey("site", mdc)) %>%
  left_join(db_visit %>%
              select(tbl_keys("visit", mdc)) %>%
              collect(),
            by = tbl_nkey("visit", mdc)) %>%
  left_join(db_survey %>%
              select(tbl_keys("survey", mdc)) %>%
              collect(),
            by = tbl_nkey("survey", mdc)) %>%
  mutate(detection_type = "capture")

# 
# # QA/QC
# 
# # exploration
# sample_unmatched = unified_sample %>%
#   anti_join(unified_capture, by=c("site", "date", "bag_id")) %>%
#   # select(site, date, bag_id, species_capture, sample_id) %>%
#   mutate(capture_id = as.character(NA)) %>%
#   filter(!is.na(bag_id))
# 
# capture_unmatched = unified_capture %>%
#   anti_join(unified_sample, by=c("site", "date", "bag_id")) %>%
#   # select(site, date, bag_id, species_capture, capture_id) %>%
#   mutate(sample_id = as.character(NA)) %>%
#   filter(!is.na(bag_id))
# 
# sample_capture_unmatched = bind_rows(capture_unmatched, sample_unmatched) %>%
#   arrange(site, date, bag_id) %>%
#   group_by(site, date) %>%
#   mutate(temp_id = cur_group_id()) %>%
#   ungroup() %>%
#   select(site, date, bag_id, species_capture, capture_id, sample_id, start_time, end_time, observer_capture, processor, observers_survey, comments_capture, comments_sample,)
# 
# write_csv(sample_capture_unmatched, here("staging", "sample_campture_unmatched.csv"))
# 
# test_site = "tuttle_pond"
# test_date = "2024-07-08"
# 
# peace = unified_sample %>%
#   filter(site == test_site,
#          date == test_date) %>%
#   arrange(bag_id)
# 
# train = unified_capture %>%
#   filter(site == test_site,
#          date == test_date) %>%
#   arrange(bag_id)

```

# Gelled capture

```{r}

# compare db and constructed columns for anything weird.
# peace = compare_df_cols(db_capture %>%
#                           filter(FALSE) %>%
#                           collect(), unified_capture)
# peace = compare_df_cols(db_survey %>%
#                           filter(FALSE) %>%
#                           collect(), unified_capture)
# peace = compare_df_cols(db_visit %>%
#                           filter(FALSE) %>%
#                           collect(), unified_capture)

gelled_capture = unified_capture %>%
  group_by_at(tbl_nkey("survey", mdc)) %>%
  mutate(start_time = as_hms(mean(start_time)),
         end_time = as_hms(mean(end_time)),
         duration_minutes = calc_duration(start_time, end_time),
         comments_survey = str_c(comments_survey, collapse = ", "),
         survey_id = ifelse(is.na(survey_id), first(temp_capture_id), survey_id),
         survey_id = ifelse(is.na(survey_id), UUIDgenerate(), survey_id)) %>%
  ungroup() %>%
  select(-temp_capture_id) %>%
  drop_na(visit_id)

```

### 5 - Subset final capture tables

```{r}
# survey
subset_capture_survey = gelled_capture %>%
  select(any_of(colnames(db_survey))) %>%
  distinct() %>%
  drop_na(survey_id)

# compare columns
compare_capture_survey = compare_df_cols(db_survey %>%
                                  filter(FALSE) %>%
                                  collect(), subset_capture_survey)

tray = compare_for_staging(db_survey %>% collect(), subset_capture_survey, tbl_pkey('survey', mdc), return_all = TRUE, report = "capture_survey")

# differences arrise in time columns which are nonsubstantial. ignoring for now
colcomp = compare_updates(tray)

final_capture_survey = bind_rows(tray$insert,
                                 tray$update)

# capture
subset_capture = gelled_capture %>%
  select(any_of(colnames(db_capture))) %>%
  distinct() %>%
  drop_na(capture_id)

# compare columns
compare_ves = compare_df_cols(db_ves %>%
                                  filter(FALSE) %>%
                                  collect(), subset_ves)


tray = compare_for_staging(db_capture %>% collect(), subset_capture, tbl_pkey('capture', mdc), return_all = TRUE, report = "capture")
final_capture = bind_rows(tray$insert,
                          tray$update)

x_capture = (nrow(final_capture_survey) > 0) | (nrow(final_capture) > 0)

```

### Stage and commit capture tables

```{r}
if (x_capture) {
  # begin transaction temp
  dbBegin(dbcon)
  
  tryCatch(
    {
      temp_capture_survey = stage_to_temp(dbcon, db_survey, final_capture_survey)
      temp_capture = stage_to_temp(dbcon, db_capture, final_capture)
      
      
      pointer = tbl(dbcon, temp_capture_survey)
      rows_upsert(db_survey, pointer, by=tbl_nkey("survey", mdc), in_place=TRUE)
      
      pointer = tbl(dbcon, temp_capture)
      rows_upsert(db_capture, pointer, by=tbl_pkey("capture", mdc), in_place=TRUE)
      
      # Commit the transaction if successful
      dbCommit(dbcon)
      print("Transaction successful!")
      
    }, error = function(e) {
      # Rollback in case of error
      dbRollback(dbcon)
      message("Transaction failed: ", e$message)
    })
}

```

## Reload tables
```{r}
db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_capture = tbl(dbcon, Id("survey_data", "capture"))
```


## CMR table

```{r}

cmr_cols <- read_csv(here("clean_tables", "penn_cmr.csv"))

final_cmr <- cmr %>% 
  select(!c(species_other, location, species)) %>% 
  unite(cmr, c("cmr_id", "cmr_id_other"), na.rm = T, sep = "") %>% 
  rename(capture_mark_recapture = fulcrum_id,
         cmr_id = cmr)

dbAppendTable(dbcon, "cmr", final_cmr)

```
