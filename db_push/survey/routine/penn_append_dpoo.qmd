---
title: "penn_append"
format: html
editor: source
---

# Setup

## Load Packages

```{r}
librarian::shelf(tidyverse, dbplyr, here, janitor, lubridate, RPostgres, stringr, DBI, parsedate, uuid, hms, RIBBiTR-BII/ribbitrrr)
# librarian::shelf(RIBBiTR-BII/ribbitrrr, update_all = TRUE)

## Connect to DB
dbcon = hopToDB("wibbitr")

## Pull metadata from database
mdc = tbl(dbcon, Id("public", "all_columns")) %>%
  filter(table_schema == "survey_data") %>%
  collect()

## Point to local data directory
ddir = Sys.getenv("data_dir")  # data directory

# Keeping .csv files in a central directory. Naming convention uses download date to distinguish batches.
wddir_2022 = here(ddir, "fulcrum", "penn", "Fulcrum_Data_2022")
wddir = here(ddir, "fulcrum", 'penn', '2024-11-18') # working data directory

```

Goals

-   Integrate batches of Penn survey data with other RIBBiTR data (including other Penn data) for combined analysis
-   Compare with existing data to avoid duplicating, and facilitate automated updating
-   Quality control for red flag data (potential or known issues)
-   Upload to Database in transaction
-   log transaction

Data chains (someday we can automate this...)

-   capture / survey / visit / site / region / country
-   aural / survey / visit / site / region / country
-   ves / survey / visit / site / region / country

# 1 - Import data

Pull dependent tables for each data chain

use naming convention "db_" to distinguish the source

## database table pointers
```{r}
# pull relevant chain tables from DB
db_sample = tbl(dbcon, Id("survey_data", "sample"))

db_aural = tbl(dbcon, Id("survey_data", "aural"))
db_capture = tbl(dbcon, Id("survey_data", "capture"))
db_edna = tbl(dbcon, Id("survey_data", "edna"))
db_env = tbl(dbcon, Id("survey_data", "environmental"))
db_ves = tbl(dbcon, Id("survey_data", "ves"))

db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_visit = tbl(dbcon, Id("survey_data", "visit"))
db_site = tbl(dbcon, Id("survey_data", "site"))
db_region = tbl(dbcon, Id("survey_data", "region"))
db_country = tbl(dbcon, Id("survey_data", "country"))

db_cmr = tbl(dbcon, Id("survey_data", "cmr"))
db_taxa = tbl(dbcon, Id("survey_data", "taxonomy"))

```

## raw CSV files

-   use naming convention "raw\_" to distinguish source
-   name related tables similarly for natural grouping

```{r}
#| include: false

list.files(here(wddir_2022, "ple_amphibian_survey"))
# 2022
# general survey table
raw_survey_info_2022 <- read_csv(here(wddir_2022, "ple_amphibian_survey", "ple_amphibian_survey.csv"))

# aural
raw_aural_survey_2022 <- read_csv(here(wddir_2022, "ple_acoustic_survey", "ple_acoustic_survey.csv"))
raw_aural_obs_2022 <- read_csv(here(wddir_2022, "ple_acoustic_survey", "ple_acoustic_survey_acoustic_survey.csv"))

# ves tables
raw_ves_survey_2022 <- read_csv(here(wddir_2022, "ple_visual_encounter_survey", "ple_visual_encounter_survey.csv"))
raw_ves_obs_2022 <- read_csv(here(wddir_2022, "ple_visual_encounter_survey", "ple_visual_encounter_survey_visual_encounter_information.csv"))

# capture tables
raw_capture_survey_2022 <- read_csv(here(wddir_2022, "ple_captured_amphibian_information", "ple_captured_amphibian_information.csv"))
raw_capture_obs_2022 <- read_csv(here(wddir_2022, "ple_captured_amphibian_information", "ple_captured_amphibian_information_captured_amphibian_information.csv"))
raw_capture_photo_2022 <- read_csv(here(wddir_2022, "ple_captured_amphibian_information", "ple_captured_amphibian_information_captured_amphibian_information_bag_photo.csv"))

raw_cmr_2022 <- read_csv(here(wddir_2022, "ple_cmr_data", "ple_cmr_data.csv"))

# sample processing & obs tables
raw_sample_processing_2022 <- read_csv(here(wddir_2022, "ple_amphibian_processing_app", "ple_amphibian_processing_app.csv"))
raw_sample_obs_2022 <- read_csv(here(wddir_2022, "ple_amphibian_processing_app", "ple_amphibian_processing_app_amphibian_capture_survey_collections.csv"))
raw_sample_photo_2022 <- read_csv(here(wddir_2022, "ple_amphibian_processing_app", "ple_amphibian_processing_app_amphibian_capture_survey_collections_photo.csv"))

# 2023 onward

# general survey table
raw_survey_info <- read_csv(here(wddir, "1_penn_surveyinformation", "1_penn_surveyinformation.csv"))

# aural tables
raw_aural_survey <- read_csv(here(wddir, "2_penn_acousticsurvey", "2_penn_acousticsurvey.csv"))
raw_aural_obs <- read_csv(here(wddir, "2_penn_acousticsurvey", "2_penn_acousticsurvey_acoustic_survey.csv"))

# ves tables
raw_ves_survey <- read_csv(here(wddir, "4_penn_visualencountersurvey", "4_penn_visualencountersurvey.csv"))
raw_ves_obs <- read_csv(here(wddir, "4_penn_visualencountersurvey", "4_penn_visualencountersurvey_visual_encounter_information.csv"))

# capture tables
raw_capture_survey <- read_csv(here(wddir, "5_penn_capturesurvey", "5_penn_capturesurvey.csv"))
raw_capture_obs <- read_csv(here(wddir, "5_penn_capturesurvey", "5_penn_capturesurvey_captured_amphibian_information.csv"))

raw_cmr <- read_csv(here(wddir, "supp_penn_cmrids", "supp_penn_cmrids.csv"))

# sample processing & obs tables
raw_sample_processing <- read_csv(here(wddir, "6_penn_sampleprocessing", "6_penn_sampleprocessing.csv"))
raw_sample_obs <- read_csv(here(wddir, "6_penn_sampleprocessing", "6_penn_sampleprocessing_amphibian_capture_survey_collections.csv"))

raw_edna_survey <- read_csv(here(wddir, "3_penn_ednasurvey", "3_penn_ednasurvey.csv"))
raw_edna_collection <- read_csv(here(wddir, "3_penn_ednasurvey", "3_penn_ednasurvey_edna_collection.csv"))
raw_edna_filtering <- read_csv(here(wddir, "3_penn_ednasurvey", "3_penn_ednasurvey_edna_collection_edna_filtering.csv"))

raw_tables = c(
  "raw_survey_info",
  "raw_aural_survey",
  "raw_aural_obs",
  "raw_ves_survey",
  "raw_ves_obs",
  "raw_capture_survey",
  "raw_capture_obs",
  "raw_cmr",
  "raw_sample_processing",
  "raw_sample_obs",
  "raw_edna_survey",
  "raw_edna_collection",
  "raw_edna_filtering"
)

local_tz = "America/New_York"

```

## 2022 clean changesets
```{r}
clean_changesets = function(fulc_table, obs = FALSE) {
  if(obs) {
    fulc_table %>%
      group_by(fulcrum_id) %>%
      mutate(max_version = max(fulcrum_record_version)) %>%
      ungroup() %>%
      filter(version == max_version)
  } else {
    fulc_table %>%
      group_by(fulcrum_id) %>%
      mutate(max_version = max(version)) %>%
      ungroup() %>%
      filter(version == max_version,
             change_type != "delete")
  }
}

raw_survey_info_2022_cs = clean_changesets(raw_survey_info_2022)
raw_aural_survey_2022_cs = clean_changesets(raw_aural_survey_2022)
raw_aural_obs_2022_cs = clean_changesets(raw_aural_obs_2022, obs = TRUE)
raw_ves_survey_2022_cs = clean_changesets(raw_ves_survey_2022)
raw_ves_obs_2022_cs = clean_changesets(raw_ves_obs_2022, obs = TRUE)
raw_capture_survey_2022_cs = clean_changesets(raw_capture_survey_2022)
raw_capture_obs_2022_cs = clean_changesets(raw_capture_obs_2022, obs = TRUE)
raw_capture_photo_2022_cs = clean_changesets(raw_capture_photo_2022, obs = TRUE)
raw_cmr_2022_cs = clean_changesets(raw_cmr_2022)
raw_sample_processing_2022_cs = clean_changesets(raw_sample_processing_2022)
raw_sample_obs_2022_cs = clean_changesets(raw_sample_obs_2022, obs = TRUE)
```


# 2 - Clean data

Drop irrelevant & fix structural issues

-   clean column names
-   rename/mutate/drop specific columns
-   Split, concatenate, coalesce related columns
-   Convert to accurate data types/units/naming conventions
-   drop unnecessary rows
-   NA formatting

```{r}

# Fulcrum columns to drop. Best practice to drop by name
to_drop = c(
  "created_at",
  "updated_at",
  "created_by",
  "updated_by",
  "system_created_at",
  "system_updated_at",
  "version",
  "status",
  "project",
  "assigned_to",
  "geometry",
  "gps_speed",
  "gps_horizontal_accuracy",
  "gps_course",
  "max_version",
  "fulcrum_record_id",
  "fulcrum_record_version",
  "site_other" # ignoring sites outside RIBBiTR... could include though.
)

peace = compare_df_cols(raw_survey_info, raw_survey_info_2022_cs)

# Begin cleaning
clean_survey_info <- bind_rows(
  raw_survey_info_2022_cs %>%
    rename(site = location) %>%
    mutate(src = 2022,
           end_time = if_else(is.na(end_time), start_time, end_time),
           survey_time = if_else(hour(end_time) > 6 & hour(end_time) < 18, "day", "night")),
  raw_survey_info %>%
    mutate(src = 2023)) %>%
  clean_names() %>% 
  rename(air_temp_c = air_temperature_c,
         air_time = air_temperature_measurement_time,
         water_temp_c = water_temperature_c,
         water_time = water_temperature_measurement_time,
         wind = wind_conditions,
         wind_speed_m_s = wind_speed_ms,
         sky = sky_conditions,
         relative_humidity_percent = humidity,
         air_pressure_psi = pressure,
         dissolved_o2_percent = dissolved_oxygen,
         tds_ppm = total_dissolved_solids,
         p_h = ph,
         conductivity_us_cm = conductivity_us,
         comments_visit = sampling_event_comments,
         temp_survey_id = fulcrum_id,
         time_of_day = survey_time,
         environmental_latitude = latitude,
         environmental_longitude = longitude) %>%
  unite(observers_survey, c("observers", "other_observers"), sep=",", remove = TRUE, na.rm = TRUE) %>%
  mutate(site = str_to_lower(site),
         site = str_replace_all(site, "-", "_"),
         site = str_replace_all(site, " ", "_"),
         time_of_day = str_to_lower(time_of_day),
         comments_visit = str_replace_all(comments_visit, "\\n", ". "),
         air_pressure_psi = ifelse(air_pressure_psi == 0, NA, air_pressure_psi),
         air_pressure_mbar = air_pressure_psi * 68.9476,
         number_observers = as.integer(str_count(observers_survey, ",") + 1)) %>%
  select(-any_of(to_drop),
         -start_time,
         -end_time) %>%
  filter(!if_all(everything(), is.na))

clean_aural_survey <- bind_rows(
  raw_aural_survey_2022_cs %>%
    rename(site = location) %>%
    mutate(end_time = if_else(is.na(end_time), start_time, end_time),
           survey_time = if_else(hour(end_time) > 6 & hour(end_time) < 18, "day", "night")),
  raw_aural_survey) %>%
  clean_names() %>% 
  rename(comments_survey = acoustic_survey_comments,
         time_of_day = survey_time,
         survey_latitude = latitude,
         survey_longitude = longitude) %>%
  mutate(site = str_to_lower(site),
         site = str_replace_all(site, "-", "_"),
         site = str_replace_all(site, " ", "_"),
         time_of_day = str_to_lower(time_of_day),
         comments_survey = str_replace_all(comments_survey, "\\n", ". "),
         detection_type = "aural",
         detection_subtype = NA_character_,
         created_at = with_tz(ymd_hms(created_at, tz = "UTC"), "America/New_York"),
         survey_date = as.Date(ifelse(hour(created_at) > 12, date(created_at), date(created_at) - days(1)), origin = "1970-01-01"),
         date = as.Date(ifelse(survey_date - date > 1, date, survey_date), origin = "1970-01-01"),
         transect = NA) %>%
  unite(observer_aural, c("observer", "observer_other"), sep=",", remove = TRUE, na.rm = TRUE) %>%
  select(-any_of(to_drop),
         -survey_date) %>%
  filter(!if_all(everything(), is.na),
         !is.na(site))  # drop any rows all null

clean_aural_obs <- bind_rows(
  raw_aural_obs_2022_cs %>%
    rename(acoustic_species_comments = acoustic_comments),
  raw_aural_obs) %>%
  clean_names() %>%
  rename(species_aural = species_acoustic,
         species_aural_other = species_acoustic_other,
         comments_aural = acoustic_species_comments) %>%
  mutate(aural_id = fulcrum_id,
         taxon_aural = coalesce(species_aural, species_aural_other),
         taxon_aural = str_to_lower(str_replace_all(taxon_aural, " ", "_")),
         comments_aural = str_replace_all(comments_aural, "\\n", ". ")) %>%
  ribbitr_clean_taxa(taxon_aural, comments_aural) %>%
  select(-any_of(to_drop),
         -species_aural_other) %>%
  filter(!if_all(everything(), is.na)) # drop any rows all null

clean_ves_survey <- bind_rows( 
  raw_ves_survey_2022_cs %>%
    rename(site = location) %>%
    mutate(end_time = if_else(is.na(end_time), start_time, end_time),
           survey_time = if_else(hour(end_time) > 6 & hour(end_time) < 18, "day", "night")),
  raw_ves_survey) %>%
  clean_names() %>% 
  rename(comments_survey = survey_description,
         time_of_day = survey_time,
         survey_latitude = latitude,
         survey_longitude = longitude) %>%
  mutate(site = str_to_lower(site),
         site = str_replace_all(site, "-", "_"),
         site = str_replace_all(site, " ", "_"),
         time_of_day = str_to_lower(time_of_day),
         comments_survey = str_replace_all(comments_survey, "\\n", ". "),
         detection_type = "visual",
         detection_subtype = NA_character_,
         created_at = with_tz(ymd_hms(created_at, tz = "UTC"), "America/New_York"),
         survey_date = as.Date(ifelse(hour(created_at) > 12, date(created_at), date(created_at) - days(1)), origin = "1970-01-01"),
         date = as.Date(ifelse(survey_date - date > 1, date, survey_date), origin = "1970-01-01"),
         transect = NA) %>%
  unite(observer_ves, c("observer", "observer_other"), sep=",", remove = TRUE, na.rm = TRUE) %>%
  select(-any_of(to_drop),
         -survey_date) %>%
  filter(!if_all(everything(), is.na),
         !is.na(site))  # drop any rows all null

clean_ves_obs <- bind_rows(
  raw_ves_obs_2022_cs,
  raw_ves_obs) %>%
  clean_names() %>%
  mutate(ves_id = fulcrum_id,
         taxon_ves = coalesce(species_ves, species_ves_other),
         taxon_ves = str_to_lower(str_replace_all(taxon_ves, " ", "_")),
         comments_ves = str_replace_all(comments_ves, "\\n", ". ")) %>%
  ribbitr_clean_taxa(taxon_ves, comments_ves) %>%
  select(-any_of(to_drop),
         -species_ves_other) %>%
  filter(!if_all(everything(), is.na))  # drop any rows all null

clean_capture_survey <- bind_rows( 
  raw_capture_survey_2022_cs %>%
    rename(site = location) %>%
    mutate(end_time = if_else(is.na(end_time), start_time, end_time),
           survey_time = if_else(hour(end_time) > 6 & hour(end_time) < 18, "day", "night")),
  raw_capture_survey) %>%
  clean_names() %>% 
  rename(comments_survey = survey_comments,
         time_of_day = survey_time,
         survey_latitude = latitude,
         survey_longitude = longitude) %>%
  mutate(site = str_to_lower(site),
         site = str_replace_all(site, "-", "_"),
         site = str_replace_all(site, " ", "_"),
         time_of_day = str_to_lower(time_of_day),
         comments_survey = str_replace_all(comments_survey, "\\n", ". "),
         detection_type = "capture",
         detection_subtype = NA_character_,
         created_at = with_tz(ymd_hms(created_at, tz = "UTC"), "America/New_York"),
         survey_date = as.Date(ifelse(hour(created_at) > 12, date(created_at), date(created_at) - days(1)), origin = "1970-01-01"),
         date = as.Date(ifelse(survey_date - date > 1, date, survey_date), origin = "1970-01-01"),
         transect = NA) %>%
  unite(observer_capture, c("observer", "observer_other"), sep=",", remove = TRUE, na.rm = TRUE) %>%
  select(-any_of(to_drop),
         -survey_date) %>%
  filter(!if_all(everything(), is.na),
         !is.na(site))  # drop any rows all null

clean_capture_obs = bind_rows(
  raw_capture_obs_2022_cs %>%
    rename(species_capture = species),
  raw_capture_obs) %>%
  clean_names() %>%
  rename(body_temp_c = body_temperature,
         comments_capture = amphibian_comments,
         capture_latitude = latitude,
         capture_longitude = longitude,
         photo_id = bag_photo) %>%
  mutate(capture_id = fulcrum_id,
         taxon_capture = coalesce(species_capture, species_capture_other),
         taxon_capture = str_to_lower(str_replace_all(taxon_capture, " ", "_")),
         comments_capture = str_replace_all(comments_capture, "\\n", ". "),
         bag_id = ifelse(bag_id == "BAG00", NA, bag_id),
         photo = !is.na(photo_id),
         microhabitat_wet = as.logical(case_match(microhabitat_wet,
                                       "yes" ~ TRUE,
                                       "no" ~ FALSE,
                                       .default = NA))) %>%
  ribbitr_clean_taxa(taxon_capture, comments_capture) %>%
  select(-any_of(to_drop),
         -all_of(c("capture_status",
                   "species_capture_other",
                   "bag_photo_caption",
                   "bag_photo_url"))) %>% # capture status: was this individual successfully captured?
  filter(!if_all(everything(), is.na))  # drop any rows all null 

clean_cmr <- bind_rows(
  raw_cmr_2022_cs,
  raw_cmr) %>%
  clean_names() %>%
  rename(site = location,
         local_cmr_id = cmr_id) %>%
  mutate(site = str_to_lower(site),
         site = str_replace_all(site, "-", "_"),
         site = str_replace_all(site, " ", "_"),
         taxon_cmr = coalesce(species, species_other),
         taxon_cmr = str_to_lower(str_replace_all(taxon_cmr, " ", "_")),
         local_cmr_id = coalesce(local_cmr_id, cmr_id_other)) %>%
  ribbitr_clean_taxa(taxon_cmr) %>%
  select(-any_of(to_drop),
         -latitude,
         -longitude,
         -species,
         -species_other,
         -cmr_id_other) %>%
  filter(!if_all(everything(), is.na))  # drop any rows all null

clean_sample_processing <- bind_rows(
  raw_sample_processing_2022_cs %>%
    mutate(survey_time = "night"),
  raw_sample_processing) %>%
  clean_names() %>%
  rename(site = location,
         comments_sample = survey_comments,
         time_of_day = survey_time) %>%
  mutate(site = str_to_lower(site),
         site = str_replace_all(site, "-", "_"),
         site = str_replace_all(site, " ", "_"),
         time_of_day = str_to_lower(time_of_day),
         created_at = with_tz(ymd_hms(created_at, tz = "UTC"), "America/New_York"),
         survey_date = as.Date(ifelse(hour(created_at) > 12, date(created_at), date(created_at) - days(1)), origin = "1970-01-01"),
         date = as.Date(ifelse(survey_date - date > 1, date, survey_date), origin = "1970-01-01"),
         detection_type = "capture",
         detection_subtype = NA_character_) %>%
  unite(processor, c("processor", "processor_other"), sep=",", remove = TRUE, na.rm = TRUE) %>%
  select(-any_of(to_drop),
         -survey_date,
         -location_other,
         -latitude,
         -longitude) %>%
  filter(!if_all(everything(), is.na)) # drop any rows all null

clean_sample_obs = bind_rows(
  raw_sample_obs_2022_cs %>%
    rename(amp_id = amp_id_1,
           antibody_id = antibody_id_1,
           bacterial_swab_id = bacterial_swab_tube_id,
           bd_swab_id = bd_swab_tube_id,
           crispr_id = crispr_swab_tube_id,
           microbiome_id = dry_swab_tube_id,
           mucosome_id = mucusome_id,
           genetic_id = toe_clip_tube_id),
  raw_sample_obs) %>%
  clean_names() %>%
  rename(svl_mm = snout_vent_length,
         body_and_bag_mass_g = body_and_bag_mass,
         bag_mass_g = bag_mass,
         body_mass_g = body_mass,
         microbiome_swab_id = microbiome_id,
         comments_sample = capture_comments) %>%
  mutate(sex = str_to_lower(sex),
         sex = ifelse(sex == "unknown", NA_character_, sex),
         sex_other = str_to_lower(sex_other),
         capture_type = str_to_lower(capture_type),
         life_stage = str_to_lower(life_stage),
         life_stage_other = str_to_lower(life_stage_other),
         taxon_sample = coalesce(species_capture, species_capture_other),
         taxon_sample = str_to_lower(str_replace_all(taxon_sample, " ", "_")),
         comments_sample = str_replace_all(comments_sample, "\\n", ". "),
         sample_id = fulcrum_id,
         negative_control = (taxon_sample == "negative_control"),
         bag_id = ifelse(negative_control, "NC", bag_id)) %>%
  ribbitr_clean_taxa(taxon_sample) %>%
  select(-any_of(to_drop),
         -fulcrum_record_id,
         -species_capture,
         -species_capture_other,
         -latitude,
         -longitude,
         -all_of(c("norep_bathvolume_50ml_acid_05ml",
                   "norep_bathvolume_100ml_acid_1ml",
                   "norep_bathvolume_200ml_acid_2ml",
                   "ul_of_norep_27mgml",
                   "ul_of_norep_135mgml",
                   "ul_of_norep_0675mgml",
                   "ul_of_norep_03375mgml",
                   "ul_of_norep_01688mgml",
                   "photo",
                   "photo_caption",
                   "photo_url",
                   "amp_ig_ne_injected",
                   "amp_ig_soak_volume",
                   "amp_ig_acidified",
                   "amp_ig_comments",
                   "bacterial_swab_id_foundations",
                   "bd_swab_id_foundations",
                   "microbiome_id_foundations",
                   "life_stage_other",
                   "sex_other"))) %>%
  filter(!if_all(everything(), is.na),
         # !(taxon_sample == "negative_control")
         !(fulcrum_id %in% c(
           "2f55cc7c-975b-458f-8f89-78e9ab53ef97",
           "484d8ef9-2f71-4b70-953d-9d0ee91b89ef",
           "b31fdc78-08fa-48c1-8661-a0a0cc635deb"))
         )

clean_edna_survey = raw_edna_survey %>%
  clean_names() %>%
  rename(comments_survey = edna_survey_comments,
         survey_latitude = latitude,
         survey_longitude = longitude) %>%
  mutate(site = str_to_lower(site),
         site = str_replace_all(site, "-", "_"),
         site = str_replace_all(site, " ", "_"),
         time_of_day = str_to_lower(survey_time),
         transect = NA,
         detection_type = "edna",
         detection_subtype = NA_character_) %>%
  unite(observer_edna, c("observer", "observer_other"), sep=",", remove = TRUE, na.rm = TRUE) %>%
  select(-any_of(to_drop)) %>%
  filter(!if_all(everything(), is.na),
         !is.na(site)) 

clean_edna_2022_cs = clean_survey_info %>%
  filter(src == 2022) %>%
  rename(edna_latitude = environmental_latitude,
         edna_longitude = environmental_longitude) %>%
  mutate(filter_method = "passive",
         collection_time = air_time,
         collection_volume_ml = edna_volume_collected_l * 1000,
         edna_id = temp_survey_id,
         detection_type = "edna",
         detection_subtype = NA_character_) %>%
  select(-any_of(to_drop))

clean_edna_collection = raw_edna_collection %>%
  clean_names() %>%
  rename(edna_latitude = latitude,
         edna_longitude = longitude,
         collection_volume_ml = edna_volume,
         filter_method = collection_type) %>%
  unite(comments_edna, c("edna_sample_comments", "edna_collection_description"), sep=" ", remove = TRUE, na.rm = TRUE) %>%
  mutate(start_time = collection_time,
         edna_id = fulcrum_id,
         frozen =  as.logical(case_match(frozen,
                                         "yes" ~ TRUE,
                                         "no" ~ FALSE)),
         negative_control = grepl("control", comments_edna),
         filter_method = tolower(gsub("-Bag", "", filter_method))) %>%
  select(-any_of(to_drop))

clean_edna_filtering  = raw_edna_filtering %>%
  clean_names() %>%
  rename(filter_date = filtration_date,
         filter_size_um = filter_size,
         filter_start_time = filtration_start_time,
         filter_end_time = filtration_end_time,
         edna_sample_name = edna_tube_id) %>%
  select(-any_of(to_drop),
         -latitude,
         -longitude)


## Revisions: Handle special cases on a row-by-row basis
# (make repeatable & unique to observation, in case this exact observation(s) shows up again in a future data import)

row_a = clean_survey_info %>%
  filter(temp_survey_id == "eea59aa0-4bae-4a1b-afa9-59c7285fbfe9")
row_b = clean_survey_info %>%
  filter(temp_survey_id == "bbe6bef2-2ca6-43f3-b5e4-5db90f3ef82f")

revision_survey_info = row_a %>%
  mutate(observers_survey = paste0(row_a$observers_survey, ",", row_b$observers_survey),
         water_time = row_b$water_time,
         water_temp_c = row_b$water_temp_c,
         tds_ppm = row_b$tds_ppm,
         p_h = row_b$p_h)

clean_survey_info = clean_survey_info %>%
  filter(!temp_survey_id %in% c("eea59aa0-4bae-4a1b-afa9-59c7285fbfe9",
                            "bbe6bef2-2ca6-43f3-b5e4-5db90f3ef82f")) %>%
  bind_rows(revision_survey_info)

# bag numbers
clean_sample_obs$bag_id[clean_sample_obs$fulcrum_id == "9f72d0b0-9252-46e6-8391-8531174e1f97"] = "BAG68"
clean_sample_obs$bag_id[clean_sample_obs$fulcrum_id == "10e912f6-fdfb-4199-b7b0-aa137df728e4"] = "BAG70"
clean_sample_obs$bag_id[clean_sample_obs$fulcrum_id == "42c0d6a7-cd2b-442e-9fe7-d7e37363de14"] = "BAG32"
clean_sample_obs$bag_id[clean_sample_obs$fulcrum_id == "5a31383d-6210-42c7-8158-0f4818f0a66a"] = "BAG24"
clean_sample_obs$bag_id[clean_sample_obs$fulcrum_id == "c844de38-b38f-43d8-a2db-6d4373ffb275"] = "BAG34"
clean_sample_obs$bag_id[clean_sample_obs$fulcrum_id == "46c33c92-feb9-47ca-91d9-b519db773d69"] = "BAG64"
clean_sample_obs$bag_id[clean_sample_obs$fulcrum_id == "6d285d19-c288-456c-8dda-42ea35352dff"] = "BAG83"
clean_sample_obs$bag_id[clean_sample_obs$fulcrum_id == "fe17b685-1c7a-4305-93cb-d3083de38654"] = "BAG16"
clean_sample_obs$bag_id[clean_sample_obs$fulcrum_id == "9f72d0b0-9252-46e6-8391-8531174e1f97"] = "BAG68"
# clean_sample_obs$bag_id[clean_sample_obs$fulcrum_id == "9fdd22ff-100c-474a-9b42-09eed5abd09a"] = "BAG68"



clean_capture_obs$bag_id[clean_capture_obs$fulcrum_id == "78e8394d-60e4-4977-9f3b-9e57601b0980"] = "BAG10"
clean_capture_obs$bag_id[clean_capture_obs$fulcrum_id == "c513fba1-d5bb-41cb-add0-5330250c6d0f"] = "BAG06"
clean_capture_obs$bag_id[clean_capture_obs$fulcrum_id == "fb9736d2-d107-42a8-b5a0-09977b405010"] = "BAG18"
clean_capture_obs$bag_id[clean_capture_obs$fulcrum_id == "862a7efb-be07-40f8-ba1f-d0f4f90a8cd8"] = "BAG15"
clean_capture_obs$bag_id[clean_capture_obs$fulcrum_id == "4d5d73e8-847f-43e8-a8f1-db8c87371946"] = "BAG01"
clean_capture_obs$bag_id[clean_capture_obs$fulcrum_id == "14ebfca0-7746-498b-ba57-141bbd9c873e"] = "BAG13"

# sites
clean_capture_survey$site[clean_capture_survey$fulcrum_id == "30c9bf7f-5949-4b26-b1f0-3147dd731f74"] = "vorisek_pond"
clean_capture_survey$site[clean_capture_survey$fulcrum_id == "e426c534-68d4-465e-92aa-252828715d49"] = "admin_pond"
clean_capture_survey$site[clean_capture_survey$fulcrum_id == "06c076fd-2014-49d1-8829-52287cd423f1"] = "tuttle_pond"

# samples
clean_sample_obs$antibody_id[clean_sample_obs$fulcrum_id == "0c6f00bb-cae1-456d-8319-0ebd319c055e"] = "Pe_IG00110"
clean_sample_obs$antibody_id_4[clean_sample_obs$fulcrum_id == "5cbfc389-fc24-4157-88e1-db8359ad4a60"] = "Pe_IG00398"
clean_sample_obs$bd_swab_id[clean_sample_obs$fulcrum_id == "e9b21478-cf75-4f3f-80ee-bd004693b55f"] = "Pe_Bd00220"
clean_sample_obs$bd_swab_id[clean_sample_obs$fulcrum_id == "63aa0e0f-a43a-4121-9a5d-ffb47391564b"] = "Pe_Bd00224"
clean_sample_obs$genetic_id[clean_sample_obs$fulcrum_id == "1f854c06-7073-4931-88b1-008a85ce739f"] = "Pe_Toe00000"
clean_sample_obs$genetic_id[clean_sample_obs$fulcrum_id == "f76279e2-987a-41eb-b6f0-b0e310342dbb"] = "Pe_Toe00029"
clean_sample_obs$microbiome_swab_id[clean_sample_obs$fulcrum_id == "c228c10b-cba5-442a-b54c-4e6a33bff8b4"] = "Pe_16S00513"
clean_sample_obs$microbiome_swab_id[clean_sample_obs$fulcrum_id == "878bf835-7368-45fc-a17f-ce8f290f1ca3"] = "Pe_16S00546"
clean_sample_obs$mucosome_id[clean_sample_obs$fulcrum_id == "c3f4fcd0-f3dc-4cd5-a886-145cbc52d2bb"] = "Pe_Muc00038"
clean_sample_obs$mucosome_id[clean_sample_obs$fulcrum_id == "c0cb8dc7-2fb3-4fb0-8055-9b5757ce64a0"] = "Pe_Muc00000"
clean_sample_obs$amp_id[clean_sample_obs$fulcrum_id == "15726e63-04ad-46fa-8f93-e7e5c5f3377a"] = "AMPBath00038"
clean_sample_obs$antibody_id[clean_sample_obs$fulcrum_id == "15726e63-04ad-46fa-8f93-e7e5c5f3377a"] = "AntiBod00038"
clean_sample_obs$amp_id_2[clean_sample_obs$fulcrum_id == "faa4a322-b353-4ae7-9066-a1f9d96e57da"] = "AMPBath00000"
clean_sample_obs$bacterial_swab_id[clean_sample_obs$fulcrum_id == "6095d594-6932-4d76-8171-8f241c24e2e4"] = "BacSwab00282"
clean_sample_obs$crispr_id[clean_sample_obs$fulcrum_id == "6095d594-6932-4d76-8171-8f241c24e2e4"] = "CRSwab00209"
clean_sample_obs$bd_swab_id[clean_sample_obs$fulcrum_id == "c83cb275-1261-4ed5-a84c-16db25ad0d8e"] = "BdSwab00203"
clean_sample_obs$microbiome_swab_id[clean_sample_obs$fulcrum_id == "c228c10b-cba5-442a-b54c-4e6a33bff8b4"] = "Pe_16S00513"
clean_sample_obs$microbiome_swab_id[clean_sample_obs$fulcrum_id == "878bf835-7368-45fc-a17f-ce8f290f1ca3"] = "Pe_16S00546"
clean_sample_obs$amp_id_2[clean_sample_obs$fulcrum_id == "639c4eba-ece0-40ea-9aa1-be09c398c627"] = "Pe_AMP00000"
clean_sample_obs$amp_id[clean_sample_obs$fulcrum_id == "08d85662-12df-479d-ae2c-e6d6dc010038"] = "Pe_AMP00153"
clean_sample_obs$bacterial_swab_id[clean_sample_obs$fulcrum_id == "7e8bd4d0-b393-4e85-8d57-c2decb0df8d4"] = "Pe_Bac00464"
clean_sample_obs$bacterial_swab_id[clean_sample_obs$fulcrum_id == "2a182461-9cfa-47ab-bedb-4dea02e5d59d"] = "Pe_Bac00520"
clean_sample_obs$bd_swab_id[clean_sample_obs$fulcrum_id == "e9b21478-cf75-4f3f-80ee-bd004693b55f"] = "Pe_Bd00220"
clean_sample_obs$bd_swab_id[clean_sample_obs$fulcrum_id == "63aa0e0f-a43a-4121-9a5d-ffb47391564b"] = "Pe_Bd00224"
clean_sample_obs$bd_swab_id[clean_sample_obs$fulcrum_id == "5f9332eb-a5b9-4b6a-85cd-4c0d47331840"] = "Pe_Bd00656"
clean_sample_obs$antibody_id[clean_sample_obs$fulcrum_id == "0c6f00bb-cae1-456d-8319-0ebd319c055e"] = "Pe_IG00110"
clean_sample_obs$antibody_id_4[clean_sample_obs$fulcrum_id == "5cbfc389-fc24-4157-88e1-db8359ad4a60"] = "Pe_IG00000"
clean_sample_obs$mucosome_id[clean_sample_obs$fulcrum_id == "c3f4fcd0-f3dc-4cd5-a886-145cbc52d2bb"] = "Pe_Muc00048"
clean_sample_obs$mucosome_id[clean_sample_obs$fulcrum_id == "6f881dea-0980-48a1-ad67-44aa27acb3a3"] = "Pe_Muc00325"
clean_sample_obs$genetic_id[clean_sample_obs$fulcrum_id == "1f854c06-7073-4931-88b1-008a85ce739f"] = "Pe_Toe00000"
clean_sample_obs$genetic_id[clean_sample_obs$fulcrum_id == "f76279e2-987a-41eb-b6f0-b0e310342dbb"] = "Pe_Toe00029"

# clean_sample_obs$mucosome_id[clean_sample_obs$fulcrum_id == "441f3864-d891-4f2a-a6f8-558b95aead39"] = "Pe_Muc00000"
clean_sample_obs$mucosome_id[clean_sample_obs$fulcrum_id == "c3f4fcd0-f3dc-4cd5-a886-145cbc52d2bb"] = "Pe_Muc00000"


# discrepancy, flag & differentiate for now
# clean_sample_obs$amp_id_2[clean_sample_obs$fulcrum_id == "4421e02c-c5d8-4070-88f7-a9e2c2498f65"] = "Pe_AMP00119"
# clean_sample_obs$bacterial_swab_id[clean_sample_obs$fulcrum_id == "2a182461-9cfa-47ab-bedb-4dea02e5d59d"] = "Pe_Bac00658_a"
# clean_sample_obs$bacterial_swab_id[clean_sample_obs$fulcrum_id == "5cbfc389-fc24-4157-88e1-db8359ad4a60"] = "Pe_Bac00658_b"
# clean_sample_obs$antibody_id_4[clean_sample_obs$fulcrum_id == "5cbfc389-fc24-4157-88e1-db8359ad4a60"] = "Pe_IG00000"
# clean_sample_obs$bd_swab_id[clean_sample_obs$fulcrum_id == "80a1f7fe-47fd-488d-a8a3-2f97c23add7c"] = "Pe_Bd00566_a"
# clean_sample_obs$bd_swab_id[clean_sample_obs$fulcrum_id == "5f9332eb-a5b9-4b6a-85cd-4c0d47331840"] = "Pe_Bd00566_b"
# clean_sample_obs$bacterial_swab_id[clean_sample_obs$fulcrum_id == "7e8bd4d0-b393-4e85-8d57-c2decb0df8d4"] = "Pe_Bac00464"
# clean_sample_obs$amp_id[clean_sample_obs$fulcrum_id == "08d85662-12df-479d-ae2c-e6d6dc010038"] = "Pe_AMP00153"
# clean_sample_obs$mucosome_id[clean_sample_obs$fulcrum_id == "c3f4fcd0-f3dc-4cd5-a886-145cbc52d2bb"] = "Pe_Muc00000"

```


# 3 - Update Chains

## Visits

### unify visits

```{r}
unique_visit <- bind_rows(clean_survey_info,
                          clean_aural_survey,
                          clean_capture_survey,
                          clean_sample_processing,
                          clean_edna_survey,
                          clean_ves_survey) %>% 
  select(date, site, time_of_day) %>%
  distinct()

unified_visit = clean_survey_info %>%
  full_join(unique_visit, by = c("site", "date", "time_of_day")) %>%
  filter(!is.na(site))

```

### gel visit

```{r}
gelled_visit = unified_visit %>%
  left_join(db_site %>%
              select(tbl_keys("site", mdc)) %>%
              collect(),
            by = tbl_nkey("site", mdc)) %>%
  left_join(db_visit %>%
              select(tbl_keys("visit", mdc)) %>%
              collect(),
            by = tbl_nkey("visit", mdc)) %>%
  group_by(site_id, date) %>%
  filter(!(is.na(time_of_day) & any(!is.na(time_of_day)))) %>%
  ungroup() %>%
  group_by_at(tbl_nkey("visit", mdc)) %>%
  mutate(comments_visit = na_if(paste0(na.omit(comments_visit), collapse = ';'), ''),
         uuid_name = paste0(site, date, time_of_day),
         visit_id = ifelse(is.na(visit_id), UUIDfromName("1aec3647-4fb5-4086-b5ea-66c947562ec6", uuid_name), visit_id)) %>%
  mutate(project_id = "ribbitr",
         visit_lab = "rz_lab")

if (nrow(gelled_visit %>% filter(is.na(site_id))) > 0) {
  stop("Unknown sites returned, consider importing first.")
}
```

### Generate stats for log

```{r}
dblog = list()
dblog$date_min = min(gelled_visit$date)
dblog$date_max = max(gelled_visit$date)
dblog$site = gelled_visit$site %>% unique()
dblog$site_id = gelled_visit$site_id %>% unique()
dblog$region = db_site %>%
  left_join(db_region, by = "region_id") %>%
  filter(site %in% dblog$sites) %>%
  pull(region) %>%
  unique()

```

### subset visit

```{r}
subset_visit = gelled_visit %>%
  select(any_of(colnames(db_visit))) %>%
  distinct() %>%
  filter(!is.na(visit_id))

compare_visit = compare_df_cols(db_visit %>%
                                  filter(FALSE) %>%
                                  collect(), subset_visit)

tray = compare_for_staging(db_visit %>%
                             filter(date >= dblog$date_min,
                                    site_id %in% dblog$site_id) %>%
                             collect(),
                           subset_visit, tbl_pkey('visit', mdc), return_all = TRUE, report = "visit")
upsert_visit = bind_rows(tray$insert,
                        tray$update)

# db_visit = db_rows_delete(dbcon, db_visit, tray$orphan, "visit_id")

peace = tray$orphan
hope = tray$insert

# # get visit_id
# vids = subset_visit %>%
#   select(visit_id) %>%
#   distinct() %>%
#   pull(visit_id)
# 
# dput(vids)

# upsert visit?
x_visit = (nrow(upsert_visit) > 0)

peace = compare_updates(tray)

```

### upsert visits

```{r}
if (x_visit) {
  temp_visit = stage_to_temp(dbcon, db_visit, upsert_visit)
  pointer = tbl(dbcon, temp_visit)
  db_visit = rows_upsert(db_visit, pointer, by="visit_id", in_place=TRUE)
}

# reload visits
db_visit = tbl(dbcon, Id("survey_data", "visit"))
```

## Environmental chain

### unify Env
```{r}
unified_env = clean_survey_info %>%
  mutate(detection_type = "environmental",
         detection_subtype = NA_character_,
         transect = NA,
         start_time = as_hms(pmin(air_time, water_time, na.rm = TRUE)),
         end_time = as_hms(pmax(air_time, water_time, na.rm = TRUE))) %>%
  left_join(db_site %>%
              select(tbl_keys("site", mdc)) %>%
              collect(),
            by = tbl_nkey("site", mdc)) %>%
  left_join(db_visit %>%
              select(tbl_keys("visit", mdc)) %>%
              collect(),
            by = tbl_nkey("visit", mdc)) %>%
  left_join(db_survey %>%
              select(tbl_keys("survey", mdc)) %>%
              filter(!is.na(visit_id)) %>%
              collect(),
            by = tbl_nkey("survey", mdc)) %>%
  left_join(db_env %>%
              select(survey_id,
                     air_time,
                     water_time,
                     environmental_id) %>%
              collect(),
            by = c("survey_id", "air_time", "water_time")) %>%
  filter(!is.na(date),
         !is.na(site_id),
         !(is.na(wind) &
             is.na(sky) &
             is.na(relative_humidity_percent) &
             is.na(air_pressure_mbar) & 
             is.na(wind_speed_m_s) &
             is.na(air_time) &
             is.na(air_temp_c) & 
             is.na(dissolved_o2_percent) &
             is.na(tds_ppm) &
             is.na(water_time) & 
             is.na(water_temp_c) &
             is.na(p_h) &
             is.na(conductivity_us_cm)))

if (nrow(unified_env %>% filter(is.na(site_id))) > 0) {
  stop("Unknown sites returned, consider importing first.")
}

```

### gel Env
```{r}
gelled_env = unified_env %>%
  group_by_at(tbl_nkey("survey", mdc)) %>%
  mutate(start_timestamp_utc = start_timestamp_utc(date, start_time, local_tz),
         end_timestamp_utc = end_timestamp_utc(date, start_time, end_time, local_tz),
         duration_minutes = duration_minutes(start_timestamp_utc, end_timestamp_utc),  # assume duration = end_time - start_time
         number_observers = count_observers(paste(observers_survey, collapse = ",")),
         uuid_name = paste0(temp_survey_id, detection_type),
         survey_id = ifelse(is.na(survey_id), UUIDfromName("5113bb6e-8cff-4a2d-9910-904403736cfb", uuid_name), survey_id)) %>%
  ungroup() %>%
  mutate(uuid_name = paste0(environmental_latitude, environmental_longitude, air_time, water_time),
         environmental_id = ifelse(is.na(environmental_id), UUIDfromName("37929955-baca-4968-9e7c-bc99bd05293c", uuid_name), environmental_id))

```

### subset Env
```{r}
# survey
subset_env_survey = gelled_env %>%
  select(any_of(colnames(db_survey))) %>%
  distinct() %>%
  filter(!is.na(survey_id))

# compare columns
compare_env_survey = compare_df_cols(db_survey %>%
                                  filter(FALSE) %>%
                                  collect(), subset_env_survey)

tray = compare_for_staging(db_survey %>% collect(), subset_env_survey, "survey_id", return_all = TRUE, report = "env_survey")
upsert_env_survey = bind_rows(tray$insert,
                               tray$update)

# env
subset_env = gelled_env %>%
  select(any_of(colnames(db_env))) %>%
  distinct() %>%
  filter(!is.na(environmental_id))

# compare columns
compare_env = compare_df_cols(db_env %>%
                                  filter(FALSE) %>%
                                  collect(), subset_env)

tray = compare_for_staging(db_env %>% collect(), subset_env, "environmental_id", return_all = TRUE, report = "env")
upsert_env = bind_rows(tray$insert,
                        tray$update)
peace = compare_updates(tray)
p1 = peace[[1]]


# anything to upsert?
x_env = (nrow(upsert_env_survey) > 0) | (nrow(upsert_env) > 0)

```

### upsert Env
```{r}

if (x_env) {
  # begin transaction temp
  dbBegin(dbcon)
  
  tryCatch(
    {
      temp_env_survey = stage_to_temp(dbcon, db_survey, upsert_env_survey)
      pointer = tbl(dbcon, temp_env_survey)
      rows_upsert(db_survey, pointer, by="survey_id", in_place=TRUE)
      
      temp_env = stage_to_temp(dbcon, db_env, upsert_env)
      pointer = tbl(dbcon, temp_env)
      rows_upsert(db_env, pointer, by="environmental_id", in_place=TRUE)
      
      # Commit the transaction if successful
      dbCommit(dbcon)
      print("Transaction successful!")
      
    }, error = function(e) {
      # Rollback in case of error
      dbRollback(dbcon)
      stop("Transaction failed: ", e$message)
    })
}

# reload
db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_env = tbl(dbcon, Id("survey_data", "environmental"))
```

## eDNA chain

### unify edna
```{r}
unified_edna = clean_edna_collection %>%
  left_join(clean_edna_filtering, by = c("fulcrum_id" = "fulcrum_parent_id")) %>%
  left_join(clean_edna_survey, by = c("fulcrum_parent_id" = "fulcrum_id")) %>%
  select(-fulcrum_parent_id) %>%
  left_join(clean_survey_info, by = c("site", "date", "time_of_day")) %>%
  bind_rows(clean_edna_2022_cs) %>%
  left_join(db_site %>%
              select(tbl_keys("site", mdc)) %>%
              collect(),
            by = tbl_nkey("site", mdc)) %>%
  left_join(db_visit %>%
              select(tbl_keys("visit", mdc)) %>%
              collect(),
            by = tbl_nkey("visit", mdc)) %>%
  left_join(db_survey %>%
              select(tbl_keys("survey", mdc)) %>%
              collect(),
            by = tbl_nkey("survey", mdc)) %>%
  filter(!is.na(site),
         !is.na(date))

```

### gel edna
```{r}
gelled_edna = unified_edna %>%
  group_by_at(tbl_nkey("survey", mdc)) %>%
  mutate(comments_survey = str_c(comments_survey, collapse = ", "),
         start_timestamp_utc = start_timestamp_utc(date, start_time, local_tz),
         number_observers = count_observers(paste(observers_survey, collapse = ",")),
         uuid_name = paste0(visit_id, start_time, transect, detection_type),
         survey_id = ifelse(is.na(survey_id),
                            UUIDfromName("5113bb6e-8cff-4a2d-9910-904403736cfb", uuid_name),
                            survey_id)) %>%
  ungroup() %>%
  group_by(date) %>%
  mutate(has_negative_control = sum(negative_control) > 0,
         negative_control_group_id = if_else(has_negative_control,
                                             UUIDfromName("42e537a1-5992-45d3-9eed-0f4920625be0", paste0("edna", date)),
                                             NA)) %>%
  ungroup() %>%
  select(-fulcrum_id)
```

### subset edna
```{r}
# survey
subset_edna_survey = gelled_edna %>%
  select(any_of(colnames(db_survey))) %>%
  distinct() %>%
  filter(!is.na(survey_id))

# compare columns
compare_edna_survey = compare_df_cols(db_survey %>%
                                  filter(FALSE) %>%
                                  collect(), subset_edna_survey)

tray = compare_for_staging(db_survey %>% collect(), subset_edna_survey, "survey_id", return_all = TRUE, report = "edna_survey")
upsert_edna_survey = bind_rows(tray$insert,
                               tray$update)

peace = get_dupes(subset_edna_survey, survey_id)

# edna
subset_edna = gelled_edna %>%
  select(any_of(colnames(db_edna))) %>%
  distinct() %>%
  filter(!is.na(edna_id))

# compare columns
compare_edna = compare_df_cols(db_edna %>%
                                  filter(FALSE) %>%
                                  collect(), subset_edna)

tray = compare_for_staging(db_edna %>% collect(), subset_edna, "edna_id", return_all = TRUE, report = "edna")
upsert_edna = bind_rows(tray$insert,
                        tray$update)

# anything to upsert?
x_edna = (nrow(upsert_edna_survey) > 0) | (nrow(upsert_edna) > 0)

```

### stage and commit edna
```{r}

if (x_edna) {
  # begin transaction temp
  dbBegin(dbcon)
  
  tryCatch(
    {
      
      db_survey = db_rows_upsert(dbcon, db_survey, upsert_edna_survey, "survey_id")
      
      db_edna = db_rows_upsert(dbcon, db_edna, upsert_edna, "edna_id")
      
      # Commit the transaction if successful
      dbCommit(dbcon)
      print("Transaction successful!")
      
    }, error = function(e) {
      # Rollback in case of error
      dbRollback(dbcon)
      stop("Transaction failed: ", e$message)
    })
}

# refresh
db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_edna = tbl(dbcon, Id("survey_data", "edna"))
```

## Aural chain

-   aural / survey / visit / site / region / location

### Unify aural data

(including unmatched surveys as "environmental". Not great though long term. Needs better fix.)

```{r}
unified_aural = clean_aural_obs %>%
  full_join(clean_aural_survey, by = c("fulcrum_parent_id" = "fulcrum_id")) %>%
  select(-fulcrum_parent_id,
         -latitude,
         -longitude) %>%
  left_join(clean_survey_info, by = c("site", "date", "time_of_day")) %>%
  left_join(db_site %>%
              select(tbl_keys("site", mdc)) %>%
              collect(),
            by = tbl_nkey("site", mdc)) %>%
  left_join(db_visit %>%
              select(tbl_keys("visit", mdc)) %>%
              collect(),
            by = tbl_nkey("visit", mdc)) %>%
  left_join(db_survey %>%
              select(tbl_keys("survey", mdc)) %>%
              filter(!is.na(visit_id)) %>%
              collect(),
            by = tbl_nkey("survey", mdc)) %>%
  filter(!is.na(site),
         !is.na(date))

if (nrow(unified_aural %>% filter(is.na(site_id))) > 0) {
  stop("Unknown sites returned, consider importing first.")
}

```

### Gelled aural data

```{r}
gelled_aural = unified_aural %>%
  group_by_at(tbl_nkey("survey", mdc)) %>%
  mutate(start_timestamp_utc = start_timestamp_utc(date, start_time, local_tz),
         end_timestamp_utc = end_timestamp_utc(date, start_time, end_time, local_tz),
         duration_minutes = duration_minutes(start_timestamp_utc, end_timestamp_utc),  # assume duration = end_time - start_time
         number_observers = count_observers(paste(observers_survey, collapse = ",")),
         comments_survey = str_c(comments_survey, collapse = ", "),
         uuid_name = paste0(visit_id, temp_survey_id, detection_type, start_time),
         survey_id = ifelse(is.na(survey_id), UUIDfromName("5113bb6e-8cff-4a2d-9910-904403736cfb", uuid_name), survey_id),
         group_id = cur_group_id()) %>%
  ungroup()

```

### Subset aural tables

```{r}

# survey
subset_aural_survey = gelled_aural %>%
  select(any_of(colnames(db_survey))) %>%
  distinct() %>%
  filter(!is.na(survey_id))

# compare columns
compare_aural_survey = compare_df_cols(db_survey %>%
                                  filter(FALSE) %>%
                                  collect(), subset_aural_survey)

tray = compare_for_staging(db_survey %>% collect(), subset_aural_survey, "survey_id", return_all = TRUE, report = "aural_survey")
peace = compare_updates(tray)
upsert_aural_survey = bind_rows(tray$insert,
                               tray$update)

# taxa
subset_aural_taxa = gelled_aural %>%
  select(taxon_aural) %>%
  drop_na(taxon_aural) %>%
  distinct() %>%
  rename(taxon_id = taxon_aural) %>%
  left_join(db_taxa %>% collect(), by = "taxon_id")

tray = compare_for_staging(db_taxa %>% collect(), subset_aural_taxa, "taxon_id", return_all = TRUE, report = "aural_taxa")
insert_aural_taxa = tray$insert

# aural
subset_aural = gelled_aural %>%
  select(any_of(colnames(db_aural))) %>%
  distinct() %>%
  filter(!is.na(aural_id))

# compare columns
compare_aural = compare_df_cols(db_aural %>%
                                  filter(FALSE) %>%
                                  collect(), subset_aural)

tray = compare_for_staging(db_aural %>% collect(), subset_aural, tbl_pkey('aural', mdc), return_all = TRUE, report = "aural")
upsert_aural = bind_rows(tray$insert,
                        tray$update)

# anything to upsert?
x_aural = (nrow(upsert_aural_survey) > 0) | (nrow(insert_aural_taxa) > 0) | (nrow(upsert_aural) > 0)

```

### Stage and commit aural tables

```{r}

if (x_aural) {
  # begin transaction temp
  dbBegin(dbcon)
  
  tryCatch(
    {
      temp_aural_survey = stage_to_temp(dbcon, db_survey, upsert_aural_survey)
      pointer = tbl(dbcon, temp_aural_survey)
      rows_upsert(db_survey, pointer, by="survey_id", in_place=TRUE)
      
      temp_aural_taxa = stage_to_temp(dbcon, db_taxa, insert_aural_taxa)
      pointer = tbl(dbcon, temp_aural_taxa)
      rows_insert(db_taxa, pointer, by="taxon_id", in_place=TRUE, conflict = "ignore")
      
      temp_aural = stage_to_temp(dbcon, db_aural, upsert_aural)
      pointer = tbl(dbcon, temp_aural)
      rows_upsert(db_aural, pointer, by="aural_id", in_place=TRUE)
      
      # Commit the transaction if successful
      dbCommit(dbcon)
      print("Transaction successful!")
      
    }, error = function(e) {
      # Rollback in case of error
      dbRollback(dbcon)
      stop("Transaction failed: ", e$message)
    })
}

# refresh
db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_aural = tbl(dbcon, Id("survey_data", "aural"))
db_taxa = tbl(dbcon, Id("survey_data", "taxonomy"))
```

## VES chain

-   ves / survey / visit / site / region / location

### Unify ves data

```{r}
unified_ves = clean_ves_obs %>%
  full_join(clean_ves_survey, by = c("fulcrum_parent_id" = "fulcrum_id")) %>%
  select(-fulcrum_parent_id) %>%
  left_join(clean_survey_info, by = c("site", "date", "time_of_day")) %>%
  left_join(db_site %>%
              select(tbl_keys("site", mdc)) %>%
              collect(),
            by = tbl_nkey("site", mdc)) %>%
  left_join(db_visit %>%
              select(tbl_keys("visit", mdc)) %>%
              collect(),
            by = tbl_nkey("visit", mdc)) %>%
  left_join(db_survey %>%
              select(tbl_keys("survey", mdc)) %>%
              filter(!is.na(visit_id)) %>%
              collect(),
            by = tbl_nkey("survey", mdc)) %>%
  filter(!is.na(site),
         !is.na(date))

if (nrow(unified_ves %>% filter(is.na(site_id))) > 0) {
  stop("Unknown sites returned, consider importing first.")
}

```

### Gel ves data

```{r}
gelled_ves = unified_ves %>%
  group_by(transect,
           detection_type,
           visit_id) %>%
  mutate(start_time = find_time_range(c(start_time, end_time))$first_time,
         end_time = find_time_range(c(start_time, end_time))$last_time,
         start_timestamp_utc = start_timestamp_utc(date, start_time, local_tz),
         end_timestamp_utc = end_timestamp_utc(date, start_time, end_time, local_tz),
         duration_minutes = duration_minutes(start_timestamp_utc, end_timestamp_utc),  # assume duration = end_time - start_time
         number_observers = count_observers(paste(observers_survey, collapse = ",")),
         comments_survey = str_c(comments_survey, collapse = ", "),
         uuid_name = paste0(visit_id, temp_survey_id, detection_type),
         survey_id = ifelse(is.na(survey_id),
                            UUIDfromName("5113bb6e-8cff-4a2d-9910-904403736cfb", uuid_name),
                            survey_id)) %>%
  ungroup() %>%
  select(-fulcrum_id)
```

### Subset final ves tables

```{r}

# survey
subset_ves_survey = gelled_ves %>%
  select(any_of(colnames(db_survey))) %>%
  distinct() %>%
  filter(!is.na(survey_id))

peace = get_dupes(subset_ves_survey, survey_id)

# compare columns
compare_ves_survey = compare_df_cols(db_survey %>%
                                  filter(FALSE) %>%
                                  collect(), subset_ves_survey)

tray = compare_for_staging(db_survey %>% collect(), subset_ves_survey, "survey_id", return_all = TRUE, report = "ves_survey")
peace = compare_updates(tray)
upsert_ves_survey = bind_rows(tray$insert,
                             tray$update)

# taxa
subset_ves_taxa = gelled_ves %>%
  select(taxon_ves) %>%
  drop_na(taxon_ves) %>%
  distinct() %>%
  rename(taxon_id = taxon_ves) %>%
  left_join(db_taxa %>% collect(), by = "taxon_id")

tray = compare_for_staging(db_taxa %>% collect(), subset_ves_taxa, "taxon_id", return_all = TRUE, report = "ves_taxa")
insert_ves_taxa = tray$insert

# ves
subset_ves = gelled_ves %>%
  select(any_of(colnames(db_ves))) %>%
  distinct() %>%
  filter(!is.na(ves_id))

# compare columns
compare_ves = compare_df_cols(db_ves %>%
                                  filter(FALSE) %>%
                                  collect(), subset_ves)

tray = compare_for_staging(db_ves %>% collect(), subset_ves, tbl_pkey('ves', mdc), return_all = TRUE, report = "ves")
upsert_ves = bind_rows(tray$insert,
                      tray$update)

x_ves = (nrow(upsert_ves_survey) > 0) | (nrow(insert_ves_taxa) > 0) | (nrow(upsert_ves) > 0)

```

### Stage and commit ves tables

```{r}
if (x_ves) {
  # begin transaction temp
  dbBegin(dbcon)
  
  tryCatch(
    {
      temp_ves_survey = stage_to_temp(dbcon, db_survey, upsert_ves_survey)
      pointer = tbl(dbcon, temp_ves_survey)
      rows_upsert(db_survey, pointer, by="survey_id", in_place=TRUE)
      
      temp_ves_taxa = stage_to_temp(dbcon, db_taxa, insert_ves_taxa)
      pointer = tbl(dbcon, temp_ves_taxa)
      rows_insert(db_taxa, pointer, by="taxon_id", in_place=TRUE, conflict = "ignore")
      
      temp_ves = stage_to_temp(dbcon, db_ves, upsert_ves)
      pointer = tbl(dbcon, temp_ves)
      rows_upsert(db_ves, pointer, by="ves_id", in_place=TRUE)
      
      # Commit the transaction if successful
      dbCommit(dbcon)
      print("Transaction successful!")
      
    }, error = function(e) {
      # Rollback in case of error
      dbRollback(dbcon)
      stop("Transaction failed: ", e$message)
    })
}

# reload
db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_ves = tbl(dbcon, Id("survey_data", "ves"))
db_taxa = tbl(dbcon, Id("survey_data", "taxonomy"))

```

## Capture chain

-   capture / survey / visit / site / region / country

### unify captures
```{r}

unified_sample =  clean_sample_obs %>% 
  full_join(clean_sample_processing, by= c("fulcrum_parent_id" = "fulcrum_id")) %>%
  unite("comments_sample", c("comments_sample.x", "comments_sample.y"), sep=",", remove = TRUE, na.rm = TRUE) %>%
  # select(-fulcrum_id,
  #      -fulcrum_parent_id) %>%
  filter(bag_id != "BAG00") %>%
  arrange(date, site, bag_id)

unified_capture = clean_capture_obs %>%
  left_join(clean_capture_survey, by = c("fulcrum_parent_id" = "fulcrum_id")) %>%
  filter(!is.na(site)) %>%  # drop captures which don't have corresponding site data in capture_survey
  select(-fulcrum_parent_id) %>%
  full_join(unified_sample, by=c("site", "date", "time_of_day", "bag_id", "detection_type", "detection_subtype")) %>%
  mutate(taxon_capture = coalesce(taxon_sample, taxon_capture),
         uuid_cap_name = paste0(taxon_capture, bag_id, svl_mm, body_mass_g, life_stage, sex, time_of_capture, site, date),
         capture_id = ifelse(is.na(capture_id), UUIDfromName("2128d8af-bb98-4206-a356-25faa67ac3f9", uuid_cap_name), capture_id)) %>%
  # select(-taxon_sample) %>%
  unite("comments_capture", c("comments_capture", "comments_sample"), sep=",", remove = TRUE, na.rm = TRUE) %>%
  left_join(clean_survey_info, by = c("site", "date", "time_of_day")) %>%
  mutate(photo = !is.na(photo_id)) %>%
  left_join(db_site %>%
              select(tbl_keys("site", mdc)) %>%
              collect(),
            by = tbl_nkey("site", mdc)) %>%
  left_join(db_visit %>%
              select(tbl_keys("visit", mdc)) %>%
              collect(),
            by = tbl_nkey("visit", mdc)) %>%
  left_join(db_survey %>%
              select(tbl_keys("survey", mdc)) %>%
              collect(),
            by = tbl_nkey("survey", mdc))

capture_dupes = get_dupes(unified_capture %>%
                            filter(!negative_control), capture_id)

# peace = get_dupes(unified_capture %>%
#                     filter(!is.na(bag_id)), "site", "date", "time_of_day", "bag_id") %>%
#   select(site,
#          date,
#          time_of_day,
#          bag_id,
#          taxon_capture,
#          taxon_sample,
#          everything())
# 
# peace = get_dupes(unified_sample %>%
#                     filter(!is.na(bag_id)), "site", "date", "time_of_day", "bag_id") %>%
#   select(site,
#          date,
#          time_of_day,
#          bag_id,
#          taxon_sample,
#          everything())



# catch for example if duplicate bad ids
if (nrow(capture_dupes) > 0) {
  stop("Duplicate captures found.")
}

if (nrow(unified_capture %>% filter(is.na(site_id))) > 0) {
  stop("Unknown sites returned, consider importing first.")
}

# peace = unified_capture %>%
#   select(fulcrum_id,
#          capture_id,
#          any_of(tbl_keys("visit", mdc)),
#          site,
#          bag_id,
#          amp_id)
# QA/QC

# exploration
sample_unmatched = unified_sample %>%
  anti_join(unified_capture, by=c("site", "date", "bag_id")) %>%
  # select(site, date, bag_id, species_capture, sample_id) %>%
  mutate(capture_id = as.character(NA)) %>%
  filter(!is.na(bag_id))

capture_unmatched = unified_capture %>%
  anti_join(unified_sample, by=c("site", "date", "bag_id")) %>%
  # select(site, date, bag_id, species_capture, capture_id) %>%
  mutate(sample_id = as.character(NA)) %>%
  filter(!is.na(bag_id))
# 
# sample_capture_unmatched = bind_rows(capture_unmatched, sample_unmatched) %>%
#   arrange(site, date, bag_id) %>%
#   group_by(site, date) %>%
#   mutate(temp_id = cur_group_id()) %>%
#   ungroup() %>%
#   select(site, date, bag_id, species_capture, capture_id, sample_id, start_time, end_time, observer_capture, processor, comments_capture, comments_sample,)
# 
# write_csv(sample_capture_unmatched, here("staging", "sample_campture_unmatched.csv"))
# 
# test_site = "rv_pond"
# test_bag = "BAG12"
# test_date = "2024-10-13"
# 
# peace = unified_sample %>%
#   filter(site == test_site,
#          # bag_id == test_bag,
#          date == test_date) %>%
#   arrange(bag_id)
# 
# train = unified_capture %>%
#   filter(site == test_site,
#          # bag_id == test_bag,
#          date == test_date) %>%
#   arrange(bag_id)

```

### CMR table

```{r}
unified_cmr = clean_cmr %>%
  left_join(unified_capture %>%
              select(capture_mark_recapture,
                     date), by = c("fulcrum_id" = "capture_mark_recapture")) %>%
  left_join(db_site %>%
              select(site,
                     site_id) %>%
              collect(), by = "site") %>%
  left_join(db_cmr %>% collect(), by = c("local_cmr_id", "taxon_cmr", "site_id" = "site_id_tagged")) %>%
  arrange(date_tagged, date) %>%
  group_by(local_cmr_id, taxon_cmr, site_id) %>%
  rename(site_id_tagged = site_id) %>%
  mutate(cmr_id = ifelse(is.na(cmr_id), first(fulcrum_id), cmr_id),
         date_tagged = as.Date(ifelse(is.na(date_tagged), min(date), date_tagged)),
         id_type = ifelse(is.na(id_type), "toe_clip", id_type)) %>%
  ungroup() %>%
  group_by(fulcrum_id) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  filter(!is.na(site_id_tagged),
         !is.na(taxon_cmr))

subset_cmr = unified_cmr %>%
  arrange(date_tagged) %>%
  group_by(local_cmr_id, taxon_cmr, site_id_tagged) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  select(any_of(colnames(db_cmr)))

compare_cmr = compare_df_cols(db_cmr %>%
                                  filter(FALSE) %>%
                                  collect(), subset_cmr)

tray = compare_for_staging(db_cmr %>% collect(), subset_cmr, "cmr_id", return_all = TRUE, report = "cmr")

upsert_cmr = bind_rows(tray$insert,
                       tray$update)

```

### gelled capture

```{r}
gelled_capture = unified_capture %>%
  left_join(unified_cmr %>%
              select(fulcrum_id, cmr_id),
            by = c("capture_mark_recapture" = "fulcrum_id")) %>%
  mutate(marked = !is.na(cmr_id)) %>%
  group_by(transect, detection_type, visit_id) %>%
  mutate(start_time = find_time_range(c(start_time, end_time, time_of_capture))$first_time,
         end_time = find_time_range(c(start_time, end_time, time_of_capture))$last_time,
         start_timestamp_utc = start_timestamp_utc(date, start_time, local_tz),
         end_timestamp_utc = end_timestamp_utc(date, start_time, end_time, local_tz),
         duration_minutes = duration_minutes(start_timestamp_utc, end_timestamp_utc),  # assume duration = end_time - start_time
         number_observers = count_observers(paste(observers_survey, collapse = ",")),
         comments_survey = str_c(comments_survey, collapse = ", "),
         uuid_name = paste0(visit_id, temp_survey_id, detection_type, start_time),
         survey_id = ifelse(is.na(survey_id),
                            UUIDfromName("5113bb6e-8cff-4a2d-9910-904403736cfb", uuid_name),
                            survey_id)) %>%
  ungroup() %>%
  timestamp_of_capture_utc(tz = local_tz) %>%
  select(-capture_mark_recapture) %>%
  arrange(date, site, time_of_capture) %>%
  drop_na(visit_id)
```

### gelled Samples

```{r}
sample_lookup_gen <- function(table, id_col, sample_cols, sample_type) {
  # unique sample ids
  all_id_cols = c(id_col,
                  "site_id",
                  "date",
                  "time_of_day",
                  "visit_id",
                  "negative_control")
  
  sample_lookup = table %>%
    select(all_of(c(sample_cols,
                  all_id_cols))) %>%
    pivot_longer(!all_of(all_id_cols), names_to = "name", values_to = "value") %>%
    filter(!is.na(value),
           # value != "Pe_Bd00000",
           # value != "Pe_Toe00000",
           # value != "Pe_16S00000",
           # value != "Pe_AMP00000",
           # value != "Pe_Muc00000",
           # value != "Pe_Bac00000",
           # value != "Pe_IG00000",
           !grepl("00000$", value)) %>%
    rename(sample_name = value) %>%
    mutate(sample_type = sample_type) %>%
    select(sample_name,
           sample_type,
           all_of(all_id_cols))
  
  return(sample_lookup)
}

s1 = sample_lookup_gen(gelled_capture, "capture_id", c("bd_swab_id"), "bd")
s2 = sample_lookup_gen(gelled_capture, "capture_id", c("genetic_id"), "genetic")
s3 = sample_lookup_gen(gelled_capture, "capture_id", c("microbiome_swab_id"), "microbiome")
s4 = sample_lookup_gen(gelled_capture, "capture_id", c("amp_id", "amp_id_2", "amp_id_3", "amp_id_4"), "amp")
s5 = sample_lookup_gen(gelled_capture, "capture_id", c("mucosome_id"), "mucosome")
s6 = sample_lookup_gen(gelled_capture, "capture_id", c("bacterial_swab_id"), "bacterial")
s7 = sample_lookup_gen(gelled_capture, "capture_id", c("antibody_id", "antibody_id_2", "antibody_id_3", "antibody_id_4"), "antibody")

select_cols = c("sample_name",
                "sample_type",
                "capture_id",
                "date",
                "visit_id",
                "negative_control")

clean_penn_sample_case <- function(dataframe, sample_name = "sample_name") {
  sample_sym <- rlang::sym(sample_name)

  # Access column properly outside of mutate
  updated_col <- dataframe[[sample_name]]
  
  updated_col <- gsub("(?i)^bdswab(\\d{5})", "BdSwab\\1", updated_col, perl = TRUE)
  updated_col <- gsub("(?i)^bacswab(\\d{5})", "BacSwab\\1", updated_col, perl = TRUE)
  updated_col <- gsub("(?i)^mucbath(\\d{5})", "MucBath\\1", updated_col, perl = TRUE)
  updated_col <- gsub("(?i)^ampbath(\\d{5})", "AMPBath\\1", updated_col, perl = TRUE)
  updated_col <- gsub("(?i)^antibod(\\d{5})", "AntiBod\\1", updated_col, perl = TRUE)
  updated_col <- gsub("(?i)^toeclip(\\d{5})", "ToeClip\\1", updated_col, perl = TRUE)
  updated_col <- gsub("(?i)^dryswab(\\d{5})", "DrySwab\\1", updated_col, perl = TRUE)
  updated_col <- gsub("(?i)^crswab(\\d{5})", "CRswab\\1", updated_col, perl = TRUE)

  dataframe %>%
    mutate(!!sample_sym := updated_col)
}

bd_dryswabs = s3 %>%
  filter(grepl("^dryswab\\d{5}$", sample_name, ignore.case = TRUE)) %>%
  mutate(sample_type = "bd")

clean_sample = rbind(s1 %>%
                     select(all_of(select_cols)),
                   s2 %>%
                     select(all_of(select_cols)),
                   s3 %>%
                     select(all_of(select_cols)),
                   s4 %>%
                     select(all_of(select_cols)),
                   s5 %>%
                     select(all_of(select_cols)),
                   s6 %>%
                     select(all_of(select_cols)),
                   s7 %>%
                     select(all_of(select_cols)),
                   bd_dryswabs %>%
                     select(all_of(select_cols))) %>%
  clean_penn_sample_case()

gelled_sample = clean_sample %>%
  left_join(db_sample %>%
              select(-capture_id,
                     -negative_control) %>%
              collect(), by = c("sample_name", "sample_type")) %>%
  mutate(uuid_name = paste0(sample_name, sample_type),
         sample_id = ifelse(is.na(sample_id), UUIDfromName("1208e62f-d3a1-462c-984f-0bf1f43f5837", uuid_name), sample_id)) %>%
  group_by(date, sample_type) %>%
  mutate(has_negative_control = sum(negative_control) > 0,
         negative_control_group_id = if_else(has_negative_control,
                                             UUIDfromName("42e537a1-5992-45d3-9eed-0f4920625be0", paste0(sample_type, date)),
                                             NA)) %>%
  ungroup() %>%
  mutate(capture_id = ifelse(negative_control, NA, capture_id),
         digits = str_extract(sample_name, "\\d{5}")) %>%
  filter(digits != "00000")
  

dupes_sample = get_dupes(gelled_sample, sample_name, sample_type)

if (nrow(dupes_sample) > 0) {
  stop("sample dupes found")
}

# # troubleshoot
# 
# fleace = gelled_capture %>%
#   filter(mucosome_id %in% dupes_sample$sample_name)

```

### drop negative controls from capture
```{r}
gelled_capture_clean = gelled_capture %>%
  filter(!negative_control)

```

### 5 - Subset final capture tables

```{r}
# survey
subset_capture_survey = gelled_capture_clean %>%
  select(any_of(colnames(db_survey))) %>%
  distinct() %>%
  filter(!is.na(survey_id))

# compare columns
compare_capture_survey = compare_df_cols(db_survey %>%
                                  filter(FALSE) %>%
                                  collect(), subset_capture_survey)

tray = compare_for_staging(db_survey %>% collect(), subset_capture_survey, "survey_id", return_all = TRUE, report = "capture_survey")
peace = compare_updates(tray)
upsert_capture_survey = bind_rows(tray$insert,
                                  tray$update)

# taxa
subset_capture_taxa = gelled_capture_clean %>%
  select(taxon_capture) %>%
  drop_na(taxon_capture) %>%
  distinct() %>%
  rename(taxon_id = taxon_capture) %>%
  left_join(db_taxa %>% collect(), by = "taxon_id")

tray = compare_for_staging(db_taxa %>% collect(), subset_capture_taxa, "taxon_id", return_all = TRUE, report = "capture_taxa")
insert_capture_taxa = tray$insert

# capture
subset_capture = gelled_capture_clean %>%
  select(any_of(colnames(db_capture))) %>%
  distinct() %>%
  filter(!is.na(capture_id))

compare_capture = compare_df_cols(db_capture %>%
                                  filter(FALSE) %>%
                                  collect(), subset_capture)


tray = compare_for_staging(db_capture %>% collect(), subset_capture, "capture_id", return_all = TRUE, report = "capture")
peace = compare_updates(tray)
upsert_capture = bind_rows(tray$insert,
                           tray$update)

hope = tray$insert

# sample
subset_sample = gelled_sample %>%
  select(any_of(colnames(db_sample))) %>%
  distinct() %>%
  filter(!is.na(sample_id))

compare_sample = compare_df_cols(db_sample %>%
                                  filter(FALSE) %>%
                                  collect(), subset_sample)


tray = compare_for_staging(db_sample %>% collect(), subset_sample, "sample_id", return_all = TRUE, report = "sample")
peace = compare_updates(tray, c("sample_name", "sample_type", "negative_control"))
upsert_sample = bind_rows(tray$insert,
                          tray$update)

##### investigate some duplicates in the database...

hope = peace[[1]]

ds_new = db_capture %>%
  left_join(db_survey, by = "survey_id") %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  filter(capture_id %in% hope$capture_id_new) %>%
  select(visit_id) %>%
  distinct() %>%
  arrange(visit_id) %>%
  pull(visit_id)

ds_old = db_capture %>%
  left_join(db_survey, by = "survey_id") %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  filter(capture_id %in% hope$capture_id_old) %>%
  select(visit_id) %>%
  distinct() %>%
  arrange(visit_id) %>%
  pull(visit_id)

common = intersect(ds_new, ds_old)

ds_surveys_new = db_capture %>%
  left_join(db_survey, by = "survey_id") %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  filter(capture_id %in% hope$capture_id_new) %>%
  select(survey_id) %>%
  distinct() %>%
  arrange(survey_id) %>%
  collect()

ds_surveys_old = db_capture %>%
  left_join(db_survey, by = "survey_id") %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  filter(capture_id %in% hope$capture_id_old) %>%
  select(survey_id) %>%
  distinct() %>%
  arrange(survey_id) %>%
  collect()

common_surveys = db_survey %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  filter(visit_id %in% common) %>%
  arrange(date, site, detection_type) %>%
  select(all_of(tbl_keys("survey", mdc)),
         all_of(tbl_keys("visit", mdc)),
         site) %>%
  collect()

drop_surveys = common_surveys %>%
  filter(!grepl("[A-Z]", observers_survey))

sids = drop_surveys %>%
  pull(survey_id)

#####

if (nrow(tray$update) > 0) {
  warning("Sample updates may indicate duplicate capture_ids. Investigation recommended.")
}
  
x_capture = (nrow(upsert_capture_survey) > 0) | (nrow(insert_capture_taxa) > 0) | (nrow(upsert_capture) > 0 | nrow(upsert_cmr) > 0 | nrow(upsert_sample) > 0)

```

### Stage and commit capture tables

```{r}
if (x_capture) {
  # begin transaction temp
  dbBegin(dbcon)
  
  tryCatch(
    {
      
      db_cmr = db_rows_upsert(dbcon, db_cmr, upsert_cmr, "cmr_id")
      
      db_survey = db_rows_upsert(dbcon, db_survey, upsert_capture_survey, "survey_id")
      
      db_taxa = db_rows_insert(dbcon, db_taxa, insert_capture_taxa, "taxon_id")
      
      db_capture = db_rows_upsert(dbcon, db_capture, upsert_capture, "capture_id")
      
      db_sample = db_rows_upsert(dbcon, db_sample, upsert_sample, "sample_id")
      
      # Commit the transaction if successful
      dbCommit(dbcon)
      print("Transaction successful!")
      
    }, error = function(e) {
      # Rollback in case of error
      dbRollback(dbcon)
      stop("Transaction failed: ", e$message)
    })
}

# reload
db_cmr = tbl(dbcon, Id("survey_data", "cmr"))
db_taxa = tbl(dbcon, Id("survey_data", "taxonomy"))
db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_capture = tbl(dbcon, Id("survey_data", "capture"))
db_sample = tbl(dbcon, Id("survey_data", "sample"))
```


```{r}
dbDisconnect(dbcon)
```
