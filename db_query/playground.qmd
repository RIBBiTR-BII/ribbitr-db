---
title: "playground"
format: html
---

```{r}
librarian::shelf(tidyverse, dbplyr, here, janitor, lubridate, RPostgres, stringr, DBI, parsedate, uuid, hms, RIBBiTR-BII/ribbitrrr)
# librarian::shelf(RIBBiTR-BII/ribbitrrr, update_all = TRUE)

## Connect to DB
dbcon <- hopToDB("ribbitr")
```

# table pointers

```{r}
# pull relevant chain tables from DB
db_bd = tbl(dbcon, Id("survey_data", "bd_qpcr_results"))
db_sample = tbl(dbcon, Id("survey_data", "sample"))

db_aural = tbl(dbcon, Id("survey_data", "aural"))
db_capture = tbl(dbcon, Id("survey_data", "capture"))
db_edna = tbl(dbcon, Id("survey_data", "edna"))
db_env = tbl(dbcon, Id("survey_data", "environmental"))
db_ves = tbl(dbcon, Id("survey_data", "ves"))

db_survey = tbl(dbcon, Id("survey_data", "survey"))
db_visit = tbl(dbcon, Id("survey_data", "visit"))
db_site = tbl(dbcon, Id("survey_data", "site"))
db_region = tbl(dbcon, Id("survey_data", "region"))
db_country = tbl(dbcon, Id("survey_data", "country"))

db_cmr = tbl(dbcon, Id("survey_data", "cmr"))
db_taxa = tbl(dbcon, Id("survey_data", "taxonomy"))

db_lab = tbl(dbcon, Id("survey_data", "lab"))

```

# determine unique values
```{r}
data_bd = db_bd %>%
  collect()

stt = sort(unique(data_bd$standard_target_type))

pp = data_bd %>%
  filter(standard_target_type == "ITS1")

```

# all km surveys
```{r}
data_km = db_survey %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  left_join(db_region, by =  "region_id") %>%
  left_join(db_country, by = "country_id") %>%
  select(detection_type,
         detection_subtype,
         description,
         date,
         time_of_day,
         visit_lab,
         project_id,
         site,
         region,
         country) %>%
  filter(
    # visit_lab == "km_pep",
    project_id == "ribbitr_pep_km",
    detection_type != "environmental"
    ) %>%
  arrange(date,
          detection_type) %>%
  collect()

poof = km_surveys %>%
  anti_join(data_km, by = c("visit_date" = "date", "survey_description" = "description"))
  

data_km = db_capture %>%
  left_join(db_survey, by = "survey_id") %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  left_join(db_region, by =  "region_id") %>%
  left_join(db_country, by = "country_id") %>%
  select(capture_id,
         taxon_capture,
         detection_type,
         detection_subtype,
         date,
         time_of_day,
         visit_lab,
         project_id,
         site,
         region,
         country) %>%
  filter(
    # visit_lab == "km_pep",
    project_id == "ribbitr_pep_km",
    ) %>%
  collect()
  
# Interesting... there are some capture surveys which are not labeled as captures... I wonder if there are any others for other projects.
data_capture_misname = db_capture %>%
  left_join(db_survey, by = "survey_id") %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  left_join(db_region, by =  "region_id") %>%
  left_join(db_country, by = "country_id") %>%
  select(detection_type,
         detection_subtype,
         date,
         time_of_day,
         visit_lab,
         project_id,
         site,
         region,
         country) %>%
  filter(
    # visit_lab == "km_pep",
    detection_type != "capture",
    ) %>%
  distinct() %>%
  collect()

data_ves_misname = db_ves %>%
  left_join(db_survey, by = "survey_id") %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  left_join(db_region, by =  "region_id") %>%
  left_join(db_country, by = "country_id") %>%
  select(ves_id,
         taxon_ves,
         detection_type,
         detection_subtype,
         date,
         time_of_day,
         visit_lab,
         project_id,
         site,
         region,
         country) %>%
  filter(
    # visit_lab == "km_pep",
    detection_type != "visual",
    ) %>%
  collect()

data_aural_misname = db_aural %>%
  left_join(db_survey, by = "survey_id") %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  left_join(db_region, by =  "region_id") %>%
  left_join(db_country, by = "country_id") %>%
  select(aural_id,
         taxon_aural,
         detection_type,
         detection_subtype,
         date,
         time_of_day,
         visit_lab,
         project_id,
         site,
         region,
         country) %>%
  filter(
    # visit_lab == "km_pep",
    detection_type != "aural",
    ) %>%
  collect()

data_env_misname = db_env %>%
  left_join(db_survey, by = "survey_id") %>%
  left_join(db_visit, by = "visit_id") %>%
  left_join(db_site, by = "site_id") %>%
  left_join(db_region, by =  "region_id") %>%
  left_join(db_country, by = "country_id") %>%
  select(environmental_id,
         detection_type,
         detection_subtype,
         date,
         time_of_day,
         visit_lab,
         project_id,
         site,
         region,
         country) %>%
  filter(
    # visit_lab == "km_pep",
    detection_type != "environmental",
    ) %>%
  collect()

# nope, looks like just from Kira's project. Interesting. I expect this was my doing, I'll fix it. Thanks Kira for helping identify this.
```